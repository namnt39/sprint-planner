<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Interactive Sprint Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .task-card {
            display: flex; flex-direction: row; align-items: flex-start;
            padding: 8px 12px; border-radius: 8px;
            margin-bottom: 8px; border: 1px solid; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            cursor: grab;
        }
        .task-card.selected {
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px #c7d2fe;
        }
        .task-card-content { flex-grow: 1; overflow: hidden; } /* Added overflow hidden */
        .task-card-checkbox { margin-top: 4px; margin-right: 8px; }
        .task-card-text {
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            display: block;
        }
        .task-card.dragging { opacity: 0.5; }
        .day-column-wrapper.drag-over { background-color: #eef2ff; }
        .task-create { background-color: #dcfce7; border-color: #bbf7d0; color: #166534; }
        .task-execute { background-color: #dbeafe; border-color: #bfdbfe; color: #1e40af; }
        .task-verify { background-color: #fee2e2; border-color: #fecaca; color: #991b1b; }
        .task-demo { background-color: #fef9c3; border-color: #fef08a; color: #854d0e; }
        
        .th-day-off-full { background-color: #fee2e2 !important; }
        .th-day-off-half { background-color: #fef3c7 !important; }
        .day-off-full { background-color: #fef2f2; }
        .day-off-half { background-image: linear-gradient(180deg, #fefce8 50%, transparent 50%); }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 50; transition: opacity 0.3s; }
        .modal-content { background-color: white; padding: 24px; border-radius: 8px; max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto; transform: scale(0.95); transition: transform 0.3s; position: relative;}
        .modal-overlay:not(.hidden) .modal-content { transform: scale(1); }
        .tab { padding: 8px 16px; cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap; }
        .tab.active { border-bottom-color: #4f46e5; color: #4f46e5; font-weight: 600; }
        .form-input { width: 100%; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; }
        
        .day-column { display: flex; flex-direction: column; height: 100%; }
        .day-action-btn {
            padding: 6px; border-radius: 6px; background-color: white;
            border: 1px solid #d1d5db; transition: all 0.2s; cursor: pointer;
        }
        .day-action-btn:hover:not(:disabled) { background-color: #f3f4f6; border-color: #a5b4fc; }
        .day-action-btn:disabled { cursor: not-allowed; opacity: 0.5; background-color: #f9fafb; }
        
        .capacity-bar { 
            position: relative;
            height: 24px; background-color: #e5e7eb; border-radius: 12px; 
            overflow: hidden; display: flex; flex-grow: 1; 
        }
        .capacity-bar > div { transition: width 0.3s; }
        .capacity-bar-text {
            position: absolute;
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: 600;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            z-index: 10;
        }
        
        .capacity-input {
            border: 1px solid #d1d5db; text-align: center; font-weight: 500;
            padding: 2px 4px; border-radius: 4px; transition: all 0.2s;
            background-color: white;
        }
        .capacity-input:hover, .capacity-input:focus { border-color: #a5b4fc; background-color: #eef2ff; }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
          -webkit-appearance: none; margin: 0;
        }
        input[type=number] { -moz-appearance: textfield; }

        .status-slider {
            position: relative; width: 100px; height: 20px; border-radius: 10px;
            cursor: pointer; user-select: none; background-color: #e5e7eb;
        }
        .status-slider-thumb {
            position: absolute; width: 26px; height: 26px; border-radius: 50%;
            background-color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            top: -3px; z-index: 10; transition: left 0.2s ease-out;
        }
        .status-slider-placeholders {
            position: absolute; inset: 0; display: flex; z-index: 5;
            transition: opacity 0.2s;
        }
        .status-slider-text {
             position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
             color: white; font-weight: bold; font-size: 11px; z-index: 5;
             transition: opacity 0.2s;
        }
        .status-slider-placeholder {
            flex: 1; display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: bold; color: rgba(0,0,0,0.4);
        }
        .status-slider[data-state="full"] .status-slider-placeholders,
        .status-slider[data-state="half"] .status-slider-placeholders {
            opacity: 0;
        }
        
        .status-slider[data-state="full"] { background-color: #f87171; } /* Red for OFF */
        .status-slider[data-state="none"] { background-color: #34d399; } /* Green for ON */
        .status-slider[data-state="half"] { background-color: #fbbf24; } /* Yellow for HALF */
        
        .toast-notification {
            position: fixed; top: 20px; left: 50%;
            transform: translate(-50%, -150%);
            padding: 12px 20px; border-radius: 8px;
            color: white; font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            transition: transform 0.4s cubic-bezier(0.2, 0.9, 0.3, 1.2);
            display: flex; align-items: center; gap: 10px;
        }
        .toast-notification.show { transform: translate(-50%, 0); }
        .toast-success { background-color: #22c55e; }
        .toast-info { background-color: #3b82f6; }
        .toast-error { background-color: #ef4444; }

        .actions-dropdown { position: relative; display: inline-block; }
        .actions-dropdown-content {
            display: none; position: absolute; background-color: white;
            min-width: 180px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1);
            z-index: 20; border-radius: 6px; overflow: hidden;
            border: 1px solid #e5e7eb;
            bottom: 100%;
            margin-bottom: 8px;
            right: 0; transform: translateX(50%);
        }
        .actions-dropdown-content.show { display: block; }
        .actions-dropdown-content button {
            color: #374151; padding: 10px 14px; text-decoration: none;
            display: flex; align-items: center; gap: 8px; width: 100%; text-align: left;
            background: white; border: none; font-size: 14px;
        }
        .actions-dropdown-content button:hover:not(:disabled) { background-color: #f9fafb; }
        .actions-dropdown-content button:disabled { color: #9ca3af; background-color: #f9fafb; cursor: not-allowed; }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-screen-2xl mx-auto">
        <div id="tabs-container" class="flex border-b border-gray-200 mb-4 overflow-x-auto"></div>
        <div id="sprint-content"></div>
    </div>
    
    <div id="generic-modal" class="modal-overlay hidden opacity-0"></div>
    <div id="toast-container"></div>
    
<script>
// --- GLOBAL STATE & CONSTANTS ---
var APP_DATA_KEY = 'multiSprintPlannerState_v53_final';
let appState = { 
    activeSprintId: null, 
    sprints: {},
    uiState: {
        lastAddTaskTab: 'Create TCs',
        lastSprintNumber: 0
    }
};

var dayMeta = {
    w1d1: { week: 1, name: 'Monday' }, w1d2: { week: 1, name: 'Tuesday' }, w1d3: { week: 1, name: 'Wednesday' },
    w1d4: { week: 1, name: 'Thursday' }, w1d5: { week: 1, name: 'Friday' },
    w2d1: { week: 2, name: 'Monday' }, w2d2: { week: 2, name: 'Tuesday' }, w2d3: { week: 2, name: 'Wednesday' },
    w2d4: { week: 2, name: 'Thursday' }, w2d5: { week: 2, name: 'Friday' }
};
const dayIdsChronological = Object.keys(dayMeta);
const dayIdsReverseChronological = [...dayIdsChronological].reverse();

var dayOffsets = {
    w1d1: 0, w1d2: 1, w1d3: 2, w1d4: 3, w1d5: 4,
    w2d1: 7, w2d2: 8, w2d3: 9, w2d4: 10, w2d5: 11
};
const INITIAL_DAILY_LIMITS = { w1d1: 4.0, w1d2: 6.75, w1d3: 5.75, w1d4: 2.75, w1d5: 6.75, w2d1: 6.75, w2d2: 6.75, w2d3: 6.75, w2d4: 4.75, w2d5: 3.5 };
const HOURS_PER_POINT = 4.5;
const STORY_SUBTASK_DISTRIBUTION = [
    { name: 'Create TCs', type: 'create', percentage: 50 }, 
    { name: 'Execute TCs', type: 'execute', percentage: 40 }, 
    { name: 'C/V Bugs', type: 'verify', percentage: 10 }
];


// --- STATE MANAGEMENT ---
function saveState() {
    try {
        localStorage.setItem(APP_DATA_KEY, JSON.stringify(appState));
    } catch (e) {
        console.error("Failed to save state:", e);
        showToast("Error: Could not save your changes.", 'error');
    }
}

function loadState() {
    try {
        const savedState = localStorage.getItem(APP_DATA_KEY);
        if (savedState) {
            const loaded = JSON.parse(savedState);
            appState = { ...appState, ...loaded };
            appState.uiState = appState.uiState || {};
            appState.uiState.lastAddTaskTab = appState.uiState.lastAddTaskTab || 'Create TCs';
            appState.uiState.lastSprintNumber = appState.uiState.lastSprintNumber || 0;

            Object.values(appState.sprints).forEach(sprint => {
                if (!sprint.exceededLogs) sprint.exceededLogs = [];
                if (!sprint.schedule) sprint.schedule = {};
                if (!sprint.daysOff) sprint.daysOff = Object.keys(dayMeta).reduce((acc, dayId) => ({...acc, [dayId]: 'none'}), {});
                if (!sprint.defaultDailyLimits) sprint.defaultDailyLimits = { ...INITIAL_DAILY_LIMITS };
                if (!sprint.initialDailyLimits) sprint.initialDailyLimits = { ...sprint.defaultDailyLimits };
            });
        }
        if (!appState.sprints || Object.keys(appState.sprints).length === 0) {
           const defaultSprintId = `sprint-${Date.now()}`;
            appState.sprints = { [defaultSprintId]: createNewSprintState("Sample Sprint") };
            appState.activeSprintId = defaultSprintId;
        }
    } catch (e) {
        console.error("Failed to load or parse saved state. Resetting to default.", e);
        const defaultSprintId = `sprint-${Date.now()}`;
        appState = {
            activeSprintId: defaultSprintId,
            sprints: { [defaultSprintId]: createNewSprintState("Sample Sprint") },
            uiState: { lastAddTaskTab: 'Create TCs', lastSprintNumber: 0 }
        };
    }
}

// --- CORE RENDERING LOGIC ---
function renderApp() {
    if (!appState.activeSprintId || !appState.sprints[appState.activeSprintId]) {
        appState.activeSprintId = Object.keys(appState.sprints)[0] || null;
    }
    renderTabs();
    if(appState.activeSprintId) {
        renderSprintContent(appState.activeSprintId);
    }
    saveState();
}

function renderTabs() {
    const tabsContainer = document.getElementById('tabs-container');
    tabsContainer.innerHTML = '';
    Object.keys(appState.sprints).forEach(sprintId => {
        const sprint = appState.sprints[sprintId];
        const tab = document.createElement('div');
        tab.className = `tab ${sprintId === appState.activeSprintId ? 'active' : ''}`;
        tab.textContent = sprint.sprintName;
        tab.onclick = () => switchTab(sprintId);
        tabsContainer.appendChild(tab);
    });

    const addTabButton = document.createElement('button');
    addTabButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg> Add Sprint`;
    addTabButton.className = 'ml-4 my-1 px-3 py-1.5 text-sm bg-indigo-100 text-indigo-700 rounded-md hover:bg-indigo-200 flex items-center';
    addTabButton.onclick = showNewSprintDialog;
    tabsContainer.appendChild(addTabButton);

    const deleteSprintButton = document.createElement('button');
    deleteSprintButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg> Delete Sprint`;
    deleteSprintButton.className = 'ml-2 my-1 px-3 py-1.5 text-sm bg-red-100 text-red-700 rounded-md hover:bg-red-200 flex items-center';
    deleteSprintButton.onclick = handleDeleteSprint;
    tabsContainer.appendChild(deleteSprintButton);
}

function renderSprintContent(sprintId) {
    const sprint = appState.sprints[sprintId];
    if (!sprint) return;

    const container = document.getElementById('sprint-content');
    container.innerHTML = `
        <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
            <input type="text" value="${sprint.sprintName}" oninput="updateSprintName(this.value)" class="text-2xl font-bold text-gray-800 bg-transparent border-b-2 border-transparent focus:border-indigo-500 outline-none w-auto max-w-full">
        </div>
        <div id="sprint-dashboard" class="mb-6"></div>
        <div class="mb-10" data-week="1"></div>
        <div data-week="2"></div>`;
    
    renderWeek(sprint, 1);
    renderWeek(sprint, 2);
    renderDashboard(sprint);
    addAppEventListeners();
}

function renderWeek(sprint, weekNumber) {
    const container = document.querySelector(`[data-week="${weekNumber}"]`);
    if(!container) return;

    const hasExceededLogs = (sprint.exceededLogs || []).some(log => dayMeta[log.dayLogged]?.week === weekNumber);

    let weekTitleHtml = `<h2 class="text-xl font-semibold text-gray-700">Week ${weekNumber}</h2>`;

    let weekButtons = `
        <button data-action="set-start-date" class="px-3 py-1 text-sm bg-blue-100 text-blue-800 rounded-md hover:bg-blue-200 flex items-center" title="Set or change the sprint's start date">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
            Set Start Date
        </button>`;

    if (hasExceededLogs) {
        weekButtons += `<button data-action="show-exceeded" data-week="${weekNumber}" class="px-3 py-1 text-sm bg-yellow-100 text-yellow-800 rounded-md hover:bg-yellow-200 flex items-center" title="Review time logged in excess of estimates">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
            Exceeded Logs
        </button>`;
    }
    weekButtons += `<button data-action="dist-demo-prep" class="px-3 py-1 text-sm bg-purple-100 text-purple-800 rounded-md hover:bg-purple-200 flex items-center" title="Distribute demo preparation time across days">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M6 10a2 2 0 11-4 0 2 2 0 014 0zM12 10a2 2 0 11-4 0 2 2 0 014 0zM16 12a2 2 0 100-4 2 2 0 000 4z" /></svg>
        Demo Prep
    </button>`;

    container.innerHTML = `
        <div class="flex items-center justify-between mb-4">
            ${weekTitleHtml}
            <div class="flex items-center gap-2">${weekButtons}</div>
        </div>
        <div class="overflow-x-auto bg-white rounded-lg shadow">${generateWeekHtml(Object.keys(dayMeta).filter(d => dayMeta[d].week === weekNumber), sprint)}</div>
    `;
    
    // Equalize column heights after rendering
    setTimeout(() => {
        const weekContainer = document.querySelector(`[data-week="${weekNumber}"]`);
        if(weekContainer) {
            const columns = weekContainer.querySelectorAll('.day-column-wrapper');
            let maxHeight = 0;
            columns.forEach(col => {
                if (col.offsetHeight > maxHeight) {
                    maxHeight = col.offsetHeight;
                }
            });
            if (maxHeight > 0) {
                 columns.forEach(col => {
                    col.style.height = `${maxHeight}px`;
                });
            }
        }
    }, 0);
}


function generateWeekHtml(days, sprint) {
    const headHtml = days.map(dayId => {
        const dateObj = sprint.startDate ? getDateForDayId(sprint.startDate, dayId) : null;
        const dateDisplay = dateObj ? dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
        const dayOffStatus = sprint.daysOff[dayId] || 'none';
        const dayHeaderClass = dayOffStatus === 'full' ? 'th-day-off-full' : (dayOffStatus === 'half' ? 'th-day-off-half' : '');
        const statusText = dayOffStatus === 'full' ? 'OFF' : dayOffStatus === 'half' ? 'HALF' : 'ON';
        
        const placeholderHtml = `<div class="status-slider-placeholder">OFF</div>
                                 <div class="status-slider-placeholder">ON</div>
                                 <div class="status-slider-placeholder">HALF</div>`;

        return `<th class="p-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider w-1/5 ${dayHeaderClass}" data-day-header-id="${dayId}">
            <div class="flex justify-between items-center mb-1">
                <span class="font-semibold text-gray-700 normal-case text-sm">${dayMeta[dayId].name}</span>
                <span class="font-bold text-gray-600 normal-case text-xs">${dateDisplay}</span>
            </div>
            
            <div class="flex justify-center items-center gap-2 mt-2 p-1">
                <div class="status-slider" data-day-id="${dayId}" data-state="${dayOffStatus}" title="Set day status: OFF / ON / HALF">
                    <div class="status-slider-text" style="opacity: ${dayOffStatus === 'none' ? '0' : '1'}">${statusText}</div>
                    <div class="status-slider-placeholders" style="opacity: ${dayOffStatus === 'none' ? '1' : '0'}">${placeholderHtml}</div>
                    <div class="status-slider-thumb"></div>
                </div>
            </div>
        </th>`;
    }).join('');
    
    let bodyHtml = '<tr>' + days.map(dayId => {
        const dayOffStatus = sprint.daysOff[dayId] || 'none';
        const tasksOnDay = sprint.schedule[dayId] || [];
        const scheduledHours = tasksOnDay.reduce((sum, t) => sum + t.hours, 0);
        const capacity = sprint.dailyLimits[dayId];
        const remainingHours = capacity - scheduledHours;
        const percentage = capacity > 0 ? (scheduledHours / capacity) * 100 : 0;
        
        const capacityText = `<span>${scheduledHours.toFixed(2)}h / ${capacity.toFixed(2)}h</span><span class="opacity-60 mx-1">|</span><span>${remainingHours.toFixed(2)}h Rem.</span>`;
        
        let barSegmentsHtml = '';
        if (capacity > 0) {
            let accumulatedPercentage = 0;
            tasksOnDay.sort((a,b) => {
                const taskA = sprint.tasks[a.taskId];
                const taskB = sprint.tasks[b.taskId];
                if (!taskA || !taskB) return 0;
                return (taskA.ticketId || '').localeCompare(taskB.ticketId || '');
            })
            .forEach(st => {
                const ti = sprint.tasks[st.taskId];
                if (!ti) return;
                
                let taskPercentage = (st.hours / capacity) * 100;
                
                if (accumulatedPercentage + taskPercentage > 100) {
                    taskPercentage = 100 - accumulatedPercentage;
                }

                const barColorClasses = {
                    create: 'bg-green-500',
                    execute: 'bg-blue-500',
                    verify: 'bg-red-500',
                    demo: 'bg-yellow-400'
                };
                const barColor = barColorClasses[ti.type] || 'bg-gray-500';
                
                if (taskPercentage > 0) {
                    barSegmentsHtml += `<div class="${barColor} h-full" style="width: ${taskPercentage}%;" title="${ti.ticketId} - ${ti.name}: ${st.hours.toFixed(2)}h"></div>`;
                }
                
                accumulatedPercentage += taskPercentage;
            });
        }

        const taskCards = tasksOnDay.map(st => {
            const ti = sprint.tasks[st.taskId];
            if (!ti) return '';
            
            const ticketIdSimple = ti.ticketId ? ti.ticketId.replace(/^NCOP-/, '') : 'N/A';
            let simpleTitle = ti.title ? ti.title.replace(new RegExp(`^${ti.ticketId}[\\s-]*`), '') : ti.name;
            const fullTooltipText = `Ticket: ${ti.ticketId}\nTask: ${ti.name}\nTitle: ${ti.title || ''}\nHours: ${st.hours.toFixed(2)}h`;

            return `
                <div class="task-card ${'task-' + ti.type}" data-scheduled-id="${st.id}" draggable="true">
                    <input type="checkbox" class="task-card-checkbox h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" data-day-id="${dayId}" data-scheduled-id="${st.id}">
                    <div class="task-card-content flex flex-col justify-between" title="${fullTooltipText}">
                        <div class="flex-grow">
                             <a href="https://oneline.atlassian.net/browse/${ti.ticketId}" target="_blank" class="font-bold text-blue-600 hover:underline text-base">${ticketIdSimple}</a>
                            <p class="task-card-text text-sm text-gray-600">${simpleTitle}</p>
                        </div>
                        <div class="flex justify-between items-center mt-2 pt-2 border-t border-black border-opacity-10">
                            <span class="text-base font-bold">${st.hours.toFixed(2)}h</span>
                            <div class="flex items-center gap-1">
                                <button class="day-action-btn" data-action="edit-single-task" data-scheduled-id="${st.id}" title="Edit Hours">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-600" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                                </button>
                                <button class="day-action-btn" data-action="delete-single-task" data-scheduled-id="${st.id}" title="Delete Task">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
        }).join('');
        
        const currentCapacity = sprint.dailyLimits[dayId];
        const initialCapacity = dayOffStatus === 'half' ? (sprint.initialDailyLimits[dayId] / 2) : sprint.initialDailyLimits[dayId];
        const isCapacityModified = Math.abs(currentCapacity - initialCapacity) > 0.01;
        
        const dayColumnClass = dayOffStatus === 'full' ? 'day-off-full' : (dayOffStatus === 'half' ? 'day-off-half' : '');
        
        const anySelected = document.querySelector(`td[data-day-id="${dayId}"] .task-card-checkbox:checked`);

        return `<td class="align-top border-l border-gray-200 ${dayColumnClass}" data-day-id="${dayId}">
            <div class="day-column-wrapper p-2 h-full flex flex-col">
                <div class="flex-grow">${taskCards}</div>
                <div class="mt-auto pt-2 space-y-2">
                     <button data-action="add-day-task" data-day-id="${dayId}" title="Add a log to this day" ${dayOffStatus === 'full' ? 'disabled' : ''} class="w-full flex items-center justify-center p-2 rounded-full bg-indigo-600 text-white hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-all shadow">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                    </button>
                    <div class="border-t pt-2">
                        <div class="flex items-center justify-between border rounded-md p-1 bg-white shadow-sm">
                            <div class="actions-dropdown">
                                <button class="day-action-btn p-2 flex items-center justify-center bg-blue-100 text-blue-800" title="Day Actions" data-action="toggle-dropdown">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                      <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
                                    </svg>
                                </button>
                                <div class="actions-dropdown-content">
                                    <button data-action="move-tasks" data-day-id="${dayId}">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L9 5.414V17a1 1 0 102 0V5.414l4.293 4.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                                        Move...
                                    </button>
                                    <button data-action="delete-selected-tasks" data-day-id="${dayId}" ${!anySelected ? 'disabled' : ''}>
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                        Delete Selected
                                    </button>
                                    <button data-action="delete-all-tasks" data-day-id="${dayId}" class="text-red-600">
                                       <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                                        Delete All
                                    </button>
                                </div>
                            </div>
                            <input type="number" class="capacity-input w-20" data-day-id="${dayId}" value="${capacity.toFixed(2)}" step="0.25" min="0.01">
                            <button class="day-action-btn p-2" ${!isCapacityModified ? 'disabled' : ''} data-action="reset-capacity" data-day-id="${dayId}" title="Reset to initial capacity (${initialCapacity.toFixed(2)}h)">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                        <div class="flex items-center gap-2 mt-2">
                            <div class="capacity-bar">
                                <div class="capacity-bar-text">${capacityText}</div>
                                ${barSegmentsHtml}
                            </div>
                            <span class="text-xs font-semibold text-gray-600 w-8 text-right">${percentage.toFixed(0)}%</span>
                        </div>
                    </div>
                </div>
            </div>
        </td>`;
    }).join('') + '</tr>';

    return `<table class="w-full min-w-[1200px] border-collapse table-fixed"><thead><tr>${headHtml}</tr></thead><tbody class="divide-y divide-gray-200">${bodyHtml}</tbody></table>`;
}

function renderDashboard(sprint) {
    const dashboard = document.getElementById('sprint-dashboard');
    const { storySummary, bugSummary, allSubTaskTypes } = getTaskSummaries(sprint);
    const { totalScheduled } = getAvailableTasks(sprint);

    const subTaskHeaderColors = {
        'Create TCs': 'bg-green-100',
        'Execute TCs': 'bg-blue-100',
        'C/V Bugs': 'bg-red-100'
    };
    
    let storyHtml = Object.entries(storySummary).map(([ticketId, story]) => {
        let isStoryExceeded = false;
        const subTaskCells = allSubTaskTypes.map(subTaskType => {
            const subTask = Object.values(story.subTasks).find(st => st.name === subTaskType);
            if (subTask) {
                const estimated = subTask.hours;
                const logged = totalScheduled[subTask.id] || 0;
                const remaining = estimated - logged;
                
                if (remaining < 0) isStoryExceeded = true;
                
                const logColor = logged > 0 ? (logged > estimated ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800') : '';
                const remColor = remaining < 0 ? 'text-red-600' : 'text-green-700';

                const exceededIcon = remaining < 0 ? `
                    <button data-action="show-exceeded-by-task" data-task-id="${subTask.id}" class="ml-1 text-yellow-500 hover:text-yellow-700" title="Exceeded by ${Math.abs(remaining).toFixed(2)}h. Click to see logs."><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                    <button data-action="adjust-exceeded-by-task" data-task-id="${subTask.id}" class="ml-1 text-blue-500 hover:text-blue-700" title="Re-assign exceeded time"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg></button>
                ` : '';

                return `
                    <td class="text-center border-l">${estimated.toFixed(2)}h</td>
                    <td class="text-center border-l"><span class="px-2 py-0.5 rounded ${logColor}">${logged.toFixed(2)}h</span></td>
                    <td class="text-center border-l"><div class="flex items-center justify-center font-semibold ${remColor}">${remaining.toFixed(2)}h ${exceededIcon}</div></td>
                `;
            }
            return '<td class="text-center border-l">-</td><td class="text-center border-l">-</td><td class="text-center border-l">-</td>';
        }).join('');
        
        const rowClass = isStoryExceeded ? 'bg-orange-100' : '';

        return `
            <tr class="${rowClass}">
                <td class="pr-2 py-2 font-medium">
                    <a href="https://oneline.atlassian.net/browse/${ticketId}" target="_blank" class="text-blue-600 hover:underline" title="${story.title}"><span>${ticketId}</span></a>
                </td>
                ${subTaskCells}
            </tr>`;
    }).join('');
    
     let bugHtml = Object.entries(bugSummary).map(([bugTaskId, bug]) => {
        const estimated = bug.totalHours;
        const logged = totalScheduled[bugTaskId] || 0;
        const remaining = estimated - logged;
        
        const isExceeded = remaining < 0;
        const rowClass = isExceeded ? 'bg-orange-100' : '';
        const logColor = logged > 0 ? (isExceeded ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800') : '';
        const remColor = isExceeded ? 'text-red-600' : 'text-green-700';

        const exceededIcon = isExceeded ? `
            <button data-action="show-exceeded-by-task" data-task-id="${bugTaskId}" class="ml-1 text-yellow-500 hover:text-yellow-700" title="Exceeded by ${Math.abs(remaining).toFixed(2)}h. Click to see logs."><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
            <button data-action="adjust-exceeded-by-task" data-task-id="${bugTaskId}" class="ml-1 text-blue-500 hover:text-blue-700" title="Re-assign exceeded time"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg></button>
        ` : '';
        return `
         <tr class="${rowClass}">
             <td class="pr-2 py-2 font-medium">
                <a href="https://oneline.atlassian.net/browse/${bug.ticketId}" target="_blank" class="text-blue-600 hover:underline" title="${bug.title}"><span>${bug.ticketId}</span></a>
             </td>
             <td class="text-center">${estimated.toFixed(2)}h</td>
             <td class="text-center"><span class="px-2 py-0.5 rounded ${logColor}">${logged.toFixed(2)}h</span></td>
             <td class="text-center"><div class="flex items-center justify-center font-semibold ${remColor}">${remaining.toFixed(2)}h ${exceededIcon}</div></td>
         </tr>
        `;
    }).join('');

    const summaryHtml = `
     <details class="bg-white rounded-lg shadow p-4" open>
        <summary class="flex justify-between items-center font-semibold cursor-pointer text-lg">
            <span>Estimate Summary</span>
            <button data-action="manage-tickets" class="px-3 py-1.5 text-sm bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 flex items-center" title="Manage sprint tickets">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg>
                Manage Tickets
            </button>
        </summary>
        <div class="mt-4 border-t pt-4 overflow-x-auto">
            <h3 class="font-semibold text-md mb-2 text-gray-700">Stories</h3>
            <table class="w-full text-sm">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="px-2 py-2 text-left w-32">Ticket</th>
                        ${allSubTaskTypes.map(st => `<th colspan="3" class="px-2 py-2 text-center border-l ${subTaskHeaderColors[st] || ''}">${st}</th>`).join('')}
                    </tr>
                     <tr class="bg-gray-50 text-xs text-gray-500">
                        <th></th>
                        ${allSubTaskTypes.map(() => `<th class="text-center font-medium border-l">Est.</th><th class="text-center font-medium border-l">Logged</th><th class="text-center font-medium border-l">Remains</th>`).join('')}
                    </tr>
                </thead>
                <tbody class="divide-y">
                    ${storyHtml || `<tr><td colspan="${1 + allSubTaskTypes.length * 3}" class="p-4 text-center text-gray-500">No stories found.</td></tr>`}
                </tbody>
            </table>
            
            <h3 class="font-semibold text-md mt-6 mb-2 text-gray-700">Bugs</h3>
            <table class="w-full text-sm">
                 <thead>
                    <tr class="bg-gray-50 text-xs text-gray-500">
                        <th class="px-2 py-2 text-left w-32">Ticket</th>
                        <th class="px-2 py-2 text-center ${subTaskHeaderColors['C/V Bugs']}">Est.</th>
                        <th class="px-2 py-2 text-center ${subTaskHeaderColors['C/V Bugs']}">Logged</th>
                        <th class="px-2 py-2 text-center ${subTaskHeaderColors['C/V Bugs']}">Remains</th>
                    </tr>
                </thead>
                 <tbody class="divide-y">
                    ${bugHtml || `<tr><td colspan="4" class="p-4 text-center text-gray-500">No bugs found.</td></tr>`}
                </tbody>
            </table>
        </div>
    </details>
    `;

    dashboard.innerHTML = summaryHtml;
}

function getTaskSummaries(sprint) {
    const storySummary = {}; // Key: ticketId
    const bugSummary = {}; // Key: taskId
    const allSubTaskTypes = new Set();

    Object.entries(sprint.tasks).forEach(([taskId, task]) => {
        if (!task.ticketId || task.ticketId === 'N/A' || task.ticketId === 'DEMO_PREP') return;
        
        const isBug = (task.type === 'verify' && task.name === 'Verify Bug');
        
        if (isBug) {
            bugSummary[taskId] = { ticketId: task.ticketId, totalHours: task.totalHours || 0, title: task.title, link: task.link };
        } else if (task.type === 'create' || task.type === 'execute' || task.name === 'C/V Bugs') {
           if (!storySummary[task.ticketId]) {
                storySummary[task.ticketId] = { title: task.title, link: task.link, subTasks: {} };
            }
            storySummary[task.ticketId].subTasks[taskId] = {name: task.name, hours: task.totalHours || 0, id: taskId};
            allSubTaskTypes.add(task.name);
        }
    });

    const sortedSubTaskTypes = Array.from(allSubTaskTypes).sort((a,b) => {
        const order = {'Create TCs': 1, 'Execute TCs': 2, 'C/V Bugs': 3};
        return (order[a] || 99) - (order[b] || 99);
    })

    return { storySummary, bugSummary, allSubTaskTypes: sortedSubTaskTypes };
}

// --- EVENT HANDLING & ACTIONS ---
function closeAllDropdowns() {
    document.querySelectorAll('.actions-dropdown-content.show').forEach(openDropdown => {
        openDropdown.classList.remove('show');
    });
}

function addAppEventListeners() {
    const sprintContent = document.getElementById('sprint-content');
    
    // This is the main click handler for the entire app content area
    sprintContent.addEventListener('click', e => {
        const actionBtn = e.target.closest('[data-action]');
        if (actionBtn) {
            e.stopPropagation(); // Stop propagation to prevent unintended side-effects
            
            if (actionBtn.dataset.action === 'toggle-dropdown') {
                 const dropdownContent = actionBtn.nextElementSibling;
                 const isVisible = dropdownContent.classList.contains('show');
                 closeAllDropdowns();
                 if (!isVisible) {
                     dropdownContent.classList.add('show');
                 }
                 return;
            }
            
            closeAllDropdowns(); // Close dropdowns for any other action

            const { action, week, scheduledId, dayId, taskId } = actionBtn.dataset;
            
            switch(action) {
                case 'manage-tickets': showManageTicketsModal(); break;
                case 'set-start-date': showCalendarModal("Set Sprint Start Date", (selectedDate) => {
                    appState.sprints[appState.activeSprintId].startDate = selectedDate;
                    renderApp();
                }); break;
                case 'show-exceeded': showExceededLogsModal(week); break;
                case 'show-exceeded-by-task': showExceededLogsModal(null, taskId); break;
                case 'adjust-exceeded-by-task': 
                    const log = (appState.sprints[appState.activeSprintId].exceededLogs || []).find(l => l.fromTaskId === taskId);
                    if(log) showReassignExceededLogModal(log.logId, dayMeta[log.dayLogged]?.week);
                    else showToast("No exceeded log found to re-assign for this task.", "info");
                    break;
                case 'dist-demo-prep': showDemoPrepModal(); break;
                case 'edit-single-task': showEditSingleTaskModal(scheduledId); break;
                case 'delete-single-task': handleDeleteSingleTask(scheduledId); break;
                case 'add-day-task': showAddTaskModal(dayId); break;
                case 'move-tasks': handleMoveTasksClick(dayId); break;
                case 'delete-selected-tasks': handleDeleteSelectedTasks(dayId); break;
                case 'delete-all-tasks': handleDeleteAllTasks(dayId); break;
                case 'reset-capacity': handleResetCapacity(dayId); break;
            }
        }
    });

    sprintContent.addEventListener('change', e => {
        if (e.target.matches('.capacity-input')) {
            handleCapacityChange(e.target.dataset.dayId, parseFloat(e.target.value));
        } else if (e.target.matches('.task-card-checkbox')) {
             e.stopPropagation();
            const dayId = e.target.dataset.dayId;
            const column = e.target.closest(`td[data-day-id="${dayId}"]`);
            
            e.target.closest('.task-card').classList.toggle('selected', e.target.checked);

            const anySelected = column.querySelector('.task-card-checkbox:checked');
            const deleteSelectedButton = column.querySelector(`[data-action="delete-selected-tasks"][data-day-id="${dayId}"]`);
            
            if (deleteSelectedButton) {
                deleteSelectedButton.disabled = !anySelected;
            }
        }
    });
    
    sprintContent.querySelectorAll('.status-slider').forEach(slider => {
        setupStatusSlider(slider);
    });

    sprintContent.addEventListener('dragstart', handleDragStart);
    sprintContent.addEventListener('dragover', handleDragOver);
    sprintContent.addEventListener('dragleave', handleDragLeave);
    sprintContent.addEventListener('drop', handleDrop);
}

window.addEventListener('click', function(event) {
    if (!event.target.closest('.actions-dropdown')) {
        closeAllDropdowns();
    }
});

function handleCapacityChange(dayId, newCapacity) {
    if (isNaN(newCapacity) || newCapacity <= 0) {
        showToast("Capacity must be greater than 0.", "error");
        renderApp(); // Revert invalid change
        return;
    }
    const sprint = appState.sprints[appState.activeSprintId];
    sprint.dailyLimits[dayId] = newCapacity;
    sprint.defaultDailyLimits[dayId] = newCapacity;
    renderApp();
}

function handleResetCapacity(dayId) {
    const sprint = appState.sprints[appState.activeSprintId];
    const dayOffStatus = sprint.daysOff[dayId];
    if (dayOffStatus === 'full') return; // Cannot reset if day is off

    let newCapacity = sprint.initialDailyLimits[dayId];
    if (dayOffStatus === 'half') {
        newCapacity /= 2;
    }
    
    sprint.dailyLimits[dayId] = newCapacity;
    sprint.defaultDailyLimits[dayId] = newCapacity;
    renderApp();
}

function handleDayStatusChange(dayId, newStatus) {
    const sprint = appState.sprints[appState.activeSprintId];
    const oldStatus = sprint.daysOff[dayId];
    if (oldStatus === newStatus) return;

    sprint.daysOff[dayId] = newStatus;
    const initialCapacity = sprint.initialDailyLimits[dayId];

    if (newStatus === 'full') {
        sprint.dailyLimits[dayId] = 0;
        const tasksToMove = sprint.schedule[dayId] || [];
        if (tasksToMove.length > 0) {
            showMoveOrDeleteTasksModal(dayId, tasksToMove);
        } else {
            renderApp();
        }
    } else if (newStatus === 'half') {
        sprint.dailyLimits[dayId] = initialCapacity / 2;
        sprint.defaultDailyLimits[dayId] = initialCapacity / 2;
        const scheduledHours = (sprint.schedule[dayId] || []).reduce((s, t) => s + t.hours, 0);
        if (scheduledHours > sprint.dailyLimits[dayId]) {
            showHalfDayAdjustmentModal(dayId);
        } else {
            renderApp();
        }
    } else { // 'none'
        sprint.dailyLimits[dayId] = initialCapacity;
        sprint.defaultDailyLimits[dayId] = initialCapacity;
        renderApp();
    }
}

function handleDeleteSingleTask(scheduledId) {
    const { dayId, scheduledTask } = findScheduledTaskById(scheduledId);
    if (!scheduledTask) return;
    
    const sprint = appState.sprints[appState.activeSprintId];
    const taskDef = sprint.tasks[scheduledTask.taskId];

    const ticketIdText = taskDef.ticketId ? taskDef.ticketId.replace(/^NCOP-/, '') : 'N/A';

    showConfirmationModal(`Are you sure you want to delete this task entry? <br>(${ticketIdText} - ${taskDef.name} - ${scheduledTask.hours}h)`, () => {
        sprint.schedule[dayId] = sprint.schedule[dayId].filter(t => t.id !== scheduledId);
        renderApp();
    });
}

function handleDeleteSelectedTasks(dayId) {
    const sprint = appState.sprints[appState.activeSprintId];
    const selectedCheckboxes = document.querySelectorAll(`td[data-day-id="${dayId}"] .task-card-checkbox:checked`);
    const scheduledIdsToDelete = new Set(Array.from(selectedCheckboxes).map(cb => cb.dataset.scheduledId));

    if (scheduledIdsToDelete.size === 0) {
        showToast("No tasks selected to delete.", "info");
        return;
    }

    showConfirmationModal(`Are you sure you want to delete the ${scheduledIdsToDelete.size} selected tasks?`, () => {
        sprint.schedule[dayId] = sprint.schedule[dayId].filter(t => !scheduledIdsToDelete.has(t.id));
        renderApp();
    });
}


function handleDeleteAllTasks(dayId) {
    const sprint = appState.sprints[appState.activeSprintId];
    if(!sprint.schedule[dayId] || sprint.schedule[dayId].length === 0) {
        showToast("No tasks to delete on this day.", "info");
        return;
    }
    
    showConfirmationModal(`Are you sure you want to delete all tasks from ${dayMeta[dayId].name}?`, () => {
        delete sprint.schedule[dayId];
        renderApp();
    });
}

// --- DRAG & DROP LOGIC ---
function handleDragStart(e) {
    const card = e.target.closest('.task-card');
    if (card) {
        e.dataTransfer.setData('text/plain', card.dataset.scheduledId);
        e.dataTransfer.effectAllowed = 'move';
        setTimeout(() => card.classList.add('dragging'), 0);
    }
}
function handleDragOver(e) {
    e.preventDefault();
    const targetDayCol = e.target.closest('.day-column-wrapper');
    if (targetDayCol) {
        const sprint = appState.sprints[appState.activeSprintId];
        if(sprint.daysOff[targetDayCol.closest('td').dataset.dayId] !== 'full') {
           document.querySelectorAll('.day-column-wrapper.drag-over').forEach(c => c.classList.remove('drag-over'));
            targetDayCol.classList.add('drag-over');
        }
    }
}
function handleDragLeave(e) {
    const dayColumn = e.target.closest('.day-column-wrapper');
    if (dayColumn && !dayColumn.contains(e.relatedTarget)) {
       dayColumn.classList.remove('drag-over');
    }
}
function handleDrop(e) {
    e.preventDefault();
    document.querySelectorAll('.task-card.dragging').forEach(c => c.classList.remove('dragging'));
    document.querySelectorAll('.day-column-wrapper.drag-over').forEach(c => c.classList.remove('drag-over'));
    const sourceScheduledId = e.dataTransfer.getData('text/plain');
    if (!sourceScheduledId) return;

    const targetDayCol = e.target.closest('.day-column-wrapper');
    const targetDayId = targetDayCol?.closest('td')?.dataset.dayId;
    
    const { dayId: sourceDayId, scheduledTask: sourceTask } = findScheduledTaskById(sourceScheduledId);

    if (targetDayId && sourceDayId && targetDayId !== sourceDayId && sourceTask) {
        executeMove([sourceTask], sourceDayId, targetDayId);
    }
}


// --- TASK MODALS (ENHANCED) ---
function showAddTaskModal(dayId, previousData = {}) {
    const sprint = appState.sprints[appState.activeSprintId];
    const { availableTasks, dayScheduledHours } = getAvailableTasks(sprint, dayId);
    const dayCapacity = sprint.dailyLimits[dayId];
    let remainingCapacity = dayCapacity - dayScheduledHours;

    const taskGroups = {};
    const groupOrder = ['Create TCs', 'Execute TCs', 'Verify Bug'];
    const typeColorClasses = { 
        create: 'border-l-4 border-green-500', 
        execute: 'border-l-4 border-blue-500', 
        verify: 'border-l-4 border-red-500', 
        demo: 'border-l-4 border-yellow-400' 
    };

    availableTasks.forEach(task => {
        if (task.unplannedHours > 0.01 || sprint.exceededLogs.some(l => l.fromTaskId === task.id)) {
            const groupName = task.name === 'Verify Bug' ? 'Verify Bug' : 
                              task.name === 'Create TCs' ? 'Create TCs' : 
                              task.name === 'Execute TCs' ? 'Execute TCs' : 'Other';
            if (!taskGroups[groupName]) taskGroups[groupName] = [];
            taskGroups[groupName].push(task);
        }
    });

    const finalGroupOrder = groupOrder.concat(Object.keys(taskGroups).filter(k => !groupOrder.includes(k) && taskGroups[k].length > 0));

    const renderTaskRow = (task) => {
        const displayText = `${task.ticketId.replace(/^NCOP-/, '')} - ${task.title || task.name}`;
        const colorClass = typeColorClasses[task.type] || 'border-l-4 border-gray-500';

        return `
        <div class="p-3 border rounded-md flex justify-between items-center bg-white ${colorClass}" data-task-id="${task.id}">
            <div class="flex-grow pr-4 overflow-hidden">
                <a href="https://oneline.atlassian.net/browse/${task.ticketId}" target="_blank" class="font-medium truncate block text-sm text-blue-600 hover:underline" title="${task.title}">${displayText}</a>
                <p class="text-xs text-gray-500 mt-1">Task: <span class="font-semibold">${task.name}</span></p>
            </div>
            <div class="w-44 flex-shrink-0 flex items-center gap-2">
                <input type="number" class="form-input add-task-hours-input text-right" placeholder="Rem: ${task.unplannedHours.toFixed(2)}h" min="0" step="0.25" value="${previousData[task.id] || ''}">
                <button class="day-action-btn p-1.5" data-action="autofill-single-task" data-task-id="${task.id}" title="Fill with remaining capacity">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" />
                    </svg>
                </button>
            </div>
        </div>
        `;
    };

    const allGroupsHtml = finalGroupOrder.map((groupName, index) => {
        const groupTasks = taskGroups[groupName] || [];
        if (groupTasks.length === 0) return '';
        
        groupTasks.sort((a, b) => (b.points || 0) - (a.points || 0));
        const groupTasksHtml = groupTasks.map(renderTaskRow).join('');

        return `
            <details class="bg-gray-50 rounded-lg border" ${index === 0 ? 'open' : ''}>
                <summary class="p-3 cursor-pointer font-semibold text-gray-700">${groupName} (${groupTasks.length})</summary>
                <div class="p-2 space-y-2 border-t bg-white">
                    ${groupTasksHtml}
                </div>
            </details>
        `;
    }).join('') || '<p class="text-center text-gray-500 p-4">No tasks available to log.</p>';
    
    const capacityWarningClass = remainingCapacity <= 0 ? 'bg-red-100 text-red-700 border border-red-200' : 'bg-blue-100 text-blue-700';

    const modalContent = showModal(`
        <div class="flex justify-between items-center mb-4">
            <div class="p-2 text-center rounded-md text-sm font-semibold ${capacityWarningClass}">
                Day Capacity: ${remainingCapacity.toFixed(2)}h remaining
            </div>
        </div>
        <div id="task-list-container" class="mt-4 space-y-3 max-h-[60vh] overflow-y-auto pr-2">${allGroupsHtml}</div>
        <div class="flex justify-end mt-6">
            <button id="confirm-add-task-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md">Add Task(s)</button>
        </div>
    `, `Add Task to ${dayMeta[dayId].name}`);
    
    modalContent.addEventListener('click', e => {
        const button = e.target.closest('[data-action="autofill-single-task"]');
        if (button) {
            handleAutofillSingleTask(button.dataset.taskId, dayId, modalContent);
        }
    });

    modalContent.querySelector('#confirm-add-task-btn').onclick = () => {
        const inputs = modalContent.querySelectorAll('.add-task-hours-input');
        let totalHoursToAdd = 0;
        const tasksToAdd = [];
        const currentData = {};
        
        inputs.forEach(input => {
            const hours = parseFloat(input.value);
            const taskId = input.closest('[data-task-id]').dataset.taskId;
            currentData[taskId] = input.value;
            if(hours > 0) {
                tasksToAdd.push({ taskId, hours });
                totalHoursToAdd += hours;
            }
        });

        if (tasksToAdd.length === 0) return showMessageModal("No hours entered for any task.", "Input Required", () => showAddTaskModal(dayId, currentData), "Back");
        
        if (totalHoursToAdd > remainingCapacity + 0.01) {
            const tasksToMoveFull = tasksToAdd.map(t => {
                const taskDef = sprint.tasks[t.taskId];
                return { ...taskDef, ...t, id: `s_temp_${t.taskId}` }; // Create temporary scheduled ID
            });
            
            showActionModal({
                title: "Capacity Exceeded",
                message: `Adding ${totalHoursToAdd.toFixed(2)}h exceeds the day's remaining capacity of ${remainingCapacity.toFixed(2)}h.`,
                buttons: [
                    { label: "Back to Edit", class: "bg-gray-200", handler: () => showAddTaskModal(dayId, currentData) },
                    { label: "Move to Another Day", class: "bg-blue-600 text-white", handler: () => showMoveTasksTargetModal(tasksToMoveFull, null) }
                ]
            });
            return;
        }
        
        addTasksToSchedule(sprint, dayId, tasksToAdd);
    };
}

function handleAutofillSingleTask(taskId, dayId, modalContent) {
    const sprint = appState.sprints[appState.activeSprintId];
    const { dayScheduledHours } = getAvailableTasks(sprint, dayId);
    const dayCapacity = sprint.dailyLimits[dayId];
    const initialRemainingCapacity = dayCapacity - dayScheduledHours;

    const allInputs = modalContent.querySelectorAll('.add-task-hours-input');
    let hoursInOtherInputs = 0;
    allInputs.forEach(input => {
        const inputTaskId = input.closest('[data-task-id]').dataset.taskId;
        if (inputTaskId !== taskId) {
            hoursInOtherInputs += parseFloat(input.value) || 0;
        }
    });

    const currentRemainingCapacity = initialRemainingCapacity - hoursInOtherInputs;
    
    const { availableTasks } = getAvailableTasks(sprint);
    const taskToFill = availableTasks.find(t => t.id === taskId);
    
    if (taskToFill) {
        const fillAmount = Math.max(0, Math.min(taskToFill.unplannedHours, currentRemainingCapacity));
        const targetInput = modalContent.querySelector(`[data-task-id="${taskId}"] .add-task-hours-input`);
        if (targetInput) {
            targetInput.value = fillAmount.toFixed(2);
        }
    }
}

function addTasksToSchedule(sprint, dayId, tasksToAdd) {
    const { availableTasks } = getAvailableTasks(sprint);
    tasksToAdd.forEach(taskData => {
        const taskInfo = availableTasks.find(t => t.id === taskData.taskId);
        let hoursToSchedule = taskData.hours;
        
        if (taskInfo && taskData.hours > taskInfo.unplannedHours + 0.01) {
            const exceededHours = taskData.hours - taskInfo.unplannedHours;
            hoursToSchedule = taskInfo.unplannedHours > 0 ? taskInfo.unplannedHours : 0;
            if (exceededHours > 0) {
                sprint.exceededLogs.push({ logId: `exlog-${Date.now()}`, fromTaskId: taskData.taskId, hours: exceededHours, dayLogged: dayId });
            }
        }
        if (!sprint.schedule[dayId]) sprint.schedule[dayId] = [];
        if (hoursToSchedule > 0) {
            const existingEntry = sprint.schedule[dayId].find(t => t.taskId === taskData.taskId);
            if (existingEntry) {
                existingEntry.hours += hoursToSchedule;
            } else {
                sprint.schedule[dayId].push({ id: `s_${dayId}_${taskData.taskId}_${Math.random()}`, taskId: taskData.taskId, hours: hoursToSchedule });
            }
        }
    });
    hideModal();
    renderApp();
}

function showEditSingleTaskModal(scheduledId) {
    const { dayId, scheduledTask } = findScheduledTaskById(scheduledId);
    if (!scheduledTask) return;
    const sprint = appState.sprints[appState.activeSprintId];
    const taskDef = sprint.tasks[scheduledTask.taskId];
    const parentTicketId = taskDef.ticketId;

    const siblingTasks = Object.entries(sprint.tasks).filter(([_, t]) => t.ticketId === parentTicketId);
    
    const taskOptionsHtml = siblingTasks.map(([id, t]) => {
        return `<option value="${id}" ${id === scheduledTask.taskId ? 'selected' : ''}>${t.name}</option>`;
    }).join('');

    const modalContent = showModal(`
        <p class="text-sm text-gray-600 mb-4">Editing task for <strong>${parentTicketId.replace(/^NCOP-/, '')}</strong> on ${dayMeta[dayId].name}.</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label for="edit-task-type" class="block text-sm font-medium text-gray-700">Task Type</label>
                <select id="edit-task-type" class="form-input mt-1">${taskOptionsHtml}</select>
            </div>
            <div>
                <label for="edit-hours-input" class="block text-sm font-medium text-gray-700">Hours</label>
                <input id="edit-hours-input" type="number" class="form-input mt-1" value="${scheduledTask.hours.toFixed(2)}" step="0.25" min="0">
            </div>
        </div>
        <div id="balance-notification" class="mt-4 p-2 text-center font-bold rounded-md"></div>
        <div class="flex justify-end mt-6">
            <button id="confirm-update-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md">Save Changes</button>
        </div>
    `, "Edit Task");
    
    const input = modalContent.querySelector('#edit-hours-input');
    const select = modalContent.querySelector('#edit-task-type');
    const notification = modalContent.querySelector('#balance-notification');
    const saveBtn = modalContent.querySelector('#confirm-update-btn');
    
    const checkBalance = () => {
        const newHours = parseFloat(input.value) || 0;
        const otherTasksHours = sprint.schedule[dayId]
            .filter(t => t.id !== scheduledId)
            .reduce((sum, t) => sum + t.hours, 0);
        const newTotal = otherTasksHours + newHours;
        const capacity = sprint.dailyLimits[dayId];
        const diff = newTotal - capacity;
        
        saveBtn.disabled = false;
        if (diff > 0.01) {
            notification.className = 'mt-4 p-2 text-center font-bold rounded-md bg-red-100 text-red-700';
            notification.textContent = `Over capacity by ${diff.toFixed(2)}h.`;
            saveBtn.disabled = true;
        } else {
            notification.className = 'mt-4 p-2 text-center font-bold rounded-md bg-green-100 text-green-700';
            notification.textContent = `Remaining capacity: ${(-diff).toFixed(2)}h.`;
        }
    };
    input.addEventListener('input', checkBalance);
    checkBalance();

    saveBtn.onclick = () => {
        const newTaskId = select.value;
        const newHours = parseFloat(input.value) || 0;
        
        sprint.schedule[dayId] = sprint.schedule[dayId].filter(t => t.id !== scheduledId);

        if (newHours > 0) {
            const existingEntry = sprint.schedule[dayId].find(t => t.taskId === newTaskId);
            if (existingEntry) {
                existingEntry.hours += newHours;
            } else {
                sprint.schedule[dayId].push({
                    id: `s_${dayId}_${newTaskId}_${Math.random()}`,
                    taskId: newTaskId,
                    hours: newHours
                });
            }
        }
        hideModal();
        renderApp();
    };
}


function switchTab(sprintId) {
    appState.activeSprintId = sprintId;
    renderApp();
}
function updateSprintName(newName) {
    const sprint = appState.sprints[appState.activeSprintId];
    if (sprint) {
        sprint.sprintName = newName;
        renderTabs();
        saveState();
    }
}
function getDateForDayId(startDateStr, dayId) {
    if (!startDateStr) return null;
    const startDate = new Date(startDateStr + 'T00:00:00');
    const offset = dayOffsets[dayId];
    const targetDate = new Date(startDate);
    targetDate.setDate(startDate.getDate() + offset);
    return targetDate;
}
function getAvailableTasks(sprint, forDayId = null) {
    let dayScheduledHours = 0;
    if(forDayId && sprint.schedule[forDayId]) {
        dayScheduledHours = sprint.schedule[forDayId].reduce((sum, task) => sum + task.hours, 0);
    }
    const totalScheduled = Object.values(sprint.schedule).flat().reduce((acc, task) => {
        if (!acc[task.taskId]) acc[task.taskId] = 0;
        acc[task.taskId] += task.hours;
        return acc;
    }, {});
    const availableTasks = Object.entries(sprint.tasks)
        .map(([taskId, taskDef]) => {
            const scheduled = totalScheduled[taskId] || 0;
            const unplannedHours = (taskDef.totalHours || 0) - scheduled;
            return { id: taskId, ...taskDef, unplannedHours: unplannedHours > 0.01 ? unplannedHours : 0, scheduledHours: scheduled };
        });
    return { availableTasks, dayScheduledHours, totalScheduled };
}
function findScheduledTaskById(id) {
    const sprint = appState.sprints[appState.activeSprintId];
    if (!sprint) return {};
    for (const dayId in sprint.schedule) {
        const scheduledTask = sprint.schedule[dayId].find(t => t.id === id);
        if (scheduledTask) return { dayId, scheduledTask };
    }
    return {};
}

// --- SPRINT CREATION & DELETION ---
function showNewSprintDialog() {
    handlePasteAndCreateClick();
}

function handlePasteAndCreateClick() {
    const nextSprintNum = appState.uiState.lastSprintNumber + 1;
    const modalContent = showModal(`
        <div class="space-y-4">
            <div class="flex items-end gap-2">
                 <span class="text-lg font-medium text-gray-700 pt-1">Sprint</span>
                <input id="new-sprint-number" type="number" class="form-input" value="${nextSprintNum}">
            </div>
            <div>
                <label for="ticket-text-ai" class="block text-sm font-medium text-gray-700">Paste Ticket Data</label>
                <div class="relative mt-1">
                    <textarea id="ticket-text-ai" class="w-full h-48 p-2 border rounded-md font-mono text-xs" placeholder="Example:\nNCOP-9382\tBug - [UAT] Incorrect Logic\t5\tB\nNCOP-9879\tEnhance scalar function\t8\tS"></textarea>
                    <button id="paste-from-clipboard-btn" class="absolute top-2 right-2 px-3 py-1 text-xs bg-gray-200 rounded-md hover:bg-gray-300">Paste</button>
                </div>
            </div>
        </div>
        <div class="flex justify-end mt-6">
            <button id="confirm-create-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md">Create Sprint</button>
        </div>`, "✨ Create New Sprint");
        
    const textArea = modalContent.querySelector('#ticket-text-ai');
    modalContent.querySelector('#paste-from-clipboard-btn').onclick = () => {
        navigator.clipboard.readText().then(text => { textArea.value = text; }).catch(err => {
            showMessageModal("Clipboard access was denied. Please paste manually.", "Clipboard Error");
        });
    };
    modalContent.querySelector('#confirm-create-btn').onclick = () => {
        const sprintNumber = modalContent.querySelector('#new-sprint-number').value.trim();
        if (!sprintNumber || isNaN(parseInt(sprintNumber))) return showMessageModal("Please enter a valid sprint number.", "Input Required");
        const sprintName = `Sprint ${sprintNumber}`;

        const ticketText = textArea.value;
        if (!ticketText.trim()) return showMessageModal("Please paste some ticket information.", "Input Required");
        
        try {
            const parsedTasks = parsePastedText(ticketText);
            if(parsedTasks.length === 0) throw new Error("Could not parse any valid tasks from the pasted text.");
            
            showConfirmDefaultTimesModal(parsedTasks, sprintName);

        } catch (e) {
            showMessageModal(`Failed to create board: ${e.message}`, "Parsing Error");
        }
    };
}

function parsePastedText(text) {
    return text.split(/[\r\n]+/).filter(line => line.trim() !== '').map(line => {
        const parts = line.split('\t').map(p => p.trim());
        if (parts.length < 4) return null;
        const [ticketId, title, pointsStr, type] = parts;
        const points = parseInt(pointsStr, 10);
        if (ticketId && title && !isNaN(points)) {
            return { ticketId, title, points, type: type.toUpperCase() };
        }
        return null;
    }).filter(Boolean);
}

function generateSubTasksForTicket(ticket) {
    const subTasks = {};
    const totalHours = ticket.points * HOURS_PER_POINT;
    const taskIdBase = `t${Date.now()}${Math.random().toString(36).substring(2, 6)}`;

    if (ticket.type.toUpperCase() === 'B') {
        subTasks[taskIdBase] = { name: 'Verify Bug', title: ticket.title, ticketId: ticket.ticketId, type: 'verify', totalHours, points: ticket.points };
    } else { // Assumes 'S' for Story
        STORY_SUBTASK_DISTRIBUTION.forEach((subTaskDef, i) => {
            const subTaskHours = totalHours * (subTaskDef.percentage / 100);
            if (subTaskHours > 0.01) {
                subTasks[`${taskIdBase}_${i}`] = { 
                    name: subTaskDef.name, 
                    title: ticket.title, 
                    ticketId: ticket.ticketId, 
                    type: subTaskDef.type, 
                    totalHours: subTaskHours, 
                    points: ticket.points 
                };
            }
        });
    }
    return subTasks;
}

function createSprintFromParsedTasks(parsedTasks, sprintName, dailyLimits) {
    let newSprint = createNewSprintState(sprintName, null, dailyLimits);
    
    (parsedTasks || []).forEach(pt => {
        const generatedSubTasks = generateSubTasksForTicket(pt);
        Object.assign(newSprint.tasks, generatedSubTasks);
    });

    newSprint.tasks['task_demo'] = { name: 'Demo Prep', ticketId: 'DEMO_PREP', type: 'demo', totalHours: 0 };
    return newSprint;
}
function createNewSprintState(name, startDate = null, dailyLimits = null) {
    const limits = dailyLimits || { ...INITIAL_DAILY_LIMITS };
    return { 
        sprintName: name, 
        startDate: startDate, 
        dailyLimits: { ...limits }, 
        defaultDailyLimits: { ...limits },
        initialDailyLimits: { ...limits }, 
        daysOff: Object.keys(dayMeta).reduce((acc, dayId) => ({...acc, [dayId]: 'none'}), {}), 
        tasks: {}, 
        schedule: {}, 
        exceededLogs: [] 
    };
}
function handleDeleteSprint() {
    if (Object.keys(appState.sprints).length <= 1) {
        return showMessageModal("Cannot delete the last sprint.", "Action not allowed");
    }
    const sprintsHtml = Object.entries(appState.sprints).map(([id, sprint]) => {
        const isDisabled = sprint.sprintName === "Sample Sprint";
        return `
        <label class="flex items-center gap-3 p-2 border rounded-md ${isDisabled ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'hover:bg-gray-50'}">
            <input type="checkbox" class="h-4 w-4 rounded sprint-delete-checkbox" value="${id}" ${isDisabled ? 'disabled' : ''}>
            <span class="font-medium text-sm">${sprint.sprintName}</span>
        </label>`
    }).join('');

    const modalContent = showModal(`
        <p class="text-sm text-gray-600 mb-4">Select the sprint(s) you want to permanently delete.</p>
        <div class="flex items-center gap-2 border-b pb-2 mb-2"><input type="checkbox" id="select-all-delete" class="h-4 w-4 rounded"><label for="select-all-delete" class="text-sm font-medium">Select All</label></div>
        <div class="space-y-2 max-h-60 overflow-y-auto">${sprintsHtml}</div>
        <div class="flex justify-end mt-6">
            <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-md">Delete Selected</button>
        </div>
    `, "Delete Sprints");
    const selectAll = modalContent.querySelector('#select-all-delete');
    const allCheckboxes = modalContent.querySelectorAll('.sprint-delete-checkbox:not(:disabled)');
    selectAll.addEventListener('change', () => {
        allCheckboxes.forEach(cb => cb.checked = selectAll.checked);
    });
    modalContent.querySelector('#confirm-delete-btn').onclick = () => {
        const checkedBoxes = modalContent.querySelectorAll('.sprint-delete-checkbox:checked');
        const idsToDelete = Array.from(checkedBoxes).map(cb => cb.value);
        if (idsToDelete.length === 0) return showMessageModal("No sprints selected.");
        if (Object.keys(appState.sprints).length - idsToDelete.length < 1) return showMessageModal("You cannot delete all sprints. At least one must remain.");
        showConfirmationModal(`Are you sure you want to delete ${idsToDelete.length} sprint(s)? This cannot be undone.`, () => {
            idsToDelete.forEach(id => delete appState.sprints[id]);
            if (idsToDelete.includes(appState.activeSprintId)) {
                appState.activeSprintId = Object.keys(appState.sprints)[0];
            }
            renderApp();
        });
    };
}

// --- DAY STATUS CHANGE MODALS ---
function showExceededLogsModal(weekNumber, taskId = null) {
    const sprint = appState.sprints[appState.activeSprintId];
    let logsForWeek = sprint.exceededLogs || [];

    if (taskId) {
        logsForWeek = logsForWeek.filter(log => log.fromTaskId === taskId);
    } else if (weekNumber) {
        logsForWeek = logsForWeek.filter(log => dayMeta[log.dayLogged]?.week == weekNumber);
    }

    if (logsForWeek.length === 0) return showMessageModal(`No exceeded logs found.`);

    const logsHtml = logsForWeek.map((log) => {
        const task = sprint.tasks[log.fromTaskId];
        return `
        <div class="p-3 rounded-lg border bg-yellow-50 flex justify-between items-center">
            <div>
                <p class="font-bold text-amber-800">Exceeded Log: ${log.hours.toFixed(2)}h</p>
                <p class="text-xs text-amber-700">From: ${task.name} (${task.ticketId}) on ${dayMeta[log.dayLogged].name}</p>
            </div>
            <button data-log-id="${log.logId}" class="reassign-exceeded-btn px-3 py-1 bg-yellow-400 text-yellow-900 text-xs font-semibold rounded-md hover:bg-yellow-500">Re-assign</button>
        </div>
    `}).join('');

    const title = taskId ? `Exceeded logs for ${sprint.tasks[taskId].name}` : `Exceeded Logs for Week ${weekNumber}`;
    const modalContent = showModal(`
        <p class="text-sm text-gray-600 mb-4">These logs represent time added beyond original estimates. Click "Re-assign" to move these hours to another task with remaining capacity.</p>
        <div class="space-y-2 max-h-72 overflow-y-auto pr-2">${logsHtml}</div>
        <div class="flex justify-end mt-6">
           <button onclick="hideModal()" class="px-4 py-2 bg-gray-200 rounded-md">Close</button>
        </div>
    `, title);
    
    modalContent.querySelectorAll('.reassign-exceeded-btn').forEach(btn => {
        btn.onclick = () => {
            showReassignExceededLogModal(btn.dataset.logId, weekNumber);
        }
    });
}

function showReassignExceededLogModal(logId, weekNumber) {
    const sprint = appState.sprints[appState.activeSprintId];
    const logToReassign = sprint.exceededLogs.find(l => l.logId === logId);
    if (!logToReassign) return showMessageModal("Log not found.");

    const { availableTasks } = getAvailableTasks(sprint);
    const suitableTasks = availableTasks.filter(t => t.unplannedHours > 0 && t.id !== logToReassign.fromTaskId);

    if (suitableTasks.length === 0) {
        return showMessageModal("No suitable tasks with remaining estimated hours found to re-assign this log to.", "No Suitable Tasks");
    }

    const tasksHtml = suitableTasks.map(task => `
        <button data-task-id="${task.id}" class="w-full text-left p-3 border rounded-md hover:bg-indigo-50 transition-colors reassign-target-task-btn">
            <div class="flex justify-between items-center">
                <span class="font-medium text-sm">${task.ticketId} - ${task.name}</span>
                <span class="text-xs text-green-600">${task.unplannedHours.toFixed(2)}h left</span>
            </div>
        </button>
    `).join('');
    
     const generateDayButtons = (week, originalDay) => {
        return Object.keys(dayMeta)
            .filter(dayId => dayMeta[dayId].week === week && sprint.daysOff[dayId] !== 'full')
            .map(dayId => `
                <label class="flex-1">
                    <input type="radio" name="reassign-target-day-radio" value="${dayId}" class="sr-only peer" ${dayId === originalDay ? 'checked' : ''}>
                    <div class="p-2 border rounded-md text-center cursor-pointer text-sm peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600 hover:bg-indigo-50">
                        <p class="font-semibold">${dayMeta[dayId].name.substring(0,3)}</p>
                    </div>
                </label>
            `).join('');
    };

    const modalContent = showModal(`
        <p class="text-sm text-gray-600 mb-2">Select a task and a day to absorb the <strong>${logToReassign.hours.toFixed(2)}h</strong> of exceeded time.</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
             <div>
                <p class="text-sm font-semibold mb-2 text-gray-600">Target Day</p>
                <div class="space-y-3">
                    <div>
                        <p class="text-xs font-medium mb-1 text-gray-500">Week 1</p>
                        <div class="flex gap-2">${generateDayButtons(1, logToReassign.dayLogged)}</div>
                    </div>
                    <div>
                        <p class="text-xs font-medium mb-1 text-gray-500">Week 2</p>
                        <div class="flex gap-2">${generateDayButtons(2, logToReassign.dayLogged)}</div>
                    </div>
                </div>
            </div>
            <div>
                 <label class="block text-sm font-medium text-gray-700 mb-1">Target Task</label>
                <div id="reassign-task-list" class="space-y-2 max-h-48 overflow-y-auto pr-2 border rounded-md p-2">${tasksHtml}</div>
            </div>
        </div>
        <div class="flex justify-end mt-6">
            <button onclick="showExceededLogsModal(${weekNumber})" class="px-4 py-2 bg-gray-200 rounded-md">Back</button>
        </div>
    `, "Re-assign Log");

    modalContent.querySelectorAll('.reassign-target-task-btn').forEach(btn => {
        btn.onclick = () => {
            const targetTaskId = btn.dataset.taskId;
            const targetDayId = modalContent.querySelector('input[name="reassign-target-day-radio"]:checked')?.value;
            
            if (!targetDayId) {
                showToast("Please select a target day.", "error");
                return;
            }

            if (!sprint.schedule[targetDayId]) sprint.schedule[targetDayId] = [];
            
            const scheduledOnTarget = (sprint.schedule[targetDayId] || []).reduce((sum, t) => sum + t.hours, 0);
            const capacityOnTarget = sprint.dailyLimits[targetDayId];

            if(scheduledOnTarget + logToReassign.hours > capacityOnTarget) {
                return showMessageModal(`Cannot re-assign. Moving ${logToReassign.hours.toFixed(2)}h to ${dayMeta[targetDayId].name} would exceed its capacity.`, 'Capacity Exceeded');
            }

            const existingEntry = sprint.schedule[targetDayId].find(t => t.taskId === targetTaskId);
            if (existingEntry) {
                existingEntry.hours += logToReassign.hours;
            } else {
                sprint.schedule[targetDayId].push({
                    id: `s_${targetDayId}_${targetTaskId}_${Math.random()}`,
                    taskId: targetTaskId,
                    hours: logToReassign.hours
                });
            }

            sprint.exceededLogs = sprint.exceededLogs.filter(l => l.logId !== logId);
            hideModal();
            renderApp();
        };
    });
}

function showDemoPrepModal() {
    const sprint = appState.sprints[appState.activeSprintId];
    
    let demoTaskId = Object.keys(sprint.tasks).find(k => sprint.tasks[k].ticketId === 'DEMO_PREP');
    if (!demoTaskId) { 
        demoTaskId = `task_demo_${Date.now()}`;
        sprint.tasks[demoTaskId] = { name: 'Demo Prep', ticketId: 'DEMO_PREP', type: 'demo', totalHours: 0 };
    }
    const currentHours = sprint.tasks[demoTaskId].totalHours;
    
    const dayCheckboxHtml = (weekNum) => Object.keys(dayMeta).filter(d => dayMeta[d].week == weekNum).map(dayId => {
        const scheduledOnDay = (sprint.schedule[dayId] || []).reduce((sum, t) => sum + t.hours, 0);
        const remainingCapacity = sprint.dailyLimits[dayId] - scheduledOnDay;
        const isChecked = (sprint.schedule[dayId] || []).some(t => t.taskId === demoTaskId);
        const isDisabled = (sprint.daysOff[dayId] === 'full' || remainingCapacity < 0.25);
        return `<label class="flex items-center space-x-2 p-1.5 border rounded-md ${isDisabled ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'hover:bg-gray-50 cursor-pointer'}">
            <input type="checkbox" value="${dayId}" class="demo-prep-day-cb h-4 w-4 rounded text-indigo-600" ${isChecked ? 'checked' : ''} ${isDisabled ? 'disabled' : ''}>
            <span class="text-xs font-medium">${dayMeta[dayId].name}</span>
        </label>`;
    }).join('');

    const allWeekHtml = (weekNum) => `<label class="flex items-center gap-2 cursor-pointer text-xs text-blue-600 hover:underline font-semibold"><input type="checkbox" data-action="select-all-week" data-week="${weekNum}" class="h-4 w-4 rounded"> All</label>`;

    showModal(`
        <p class="text-sm text-gray-600 mb-4">Enter the total hours for demo prep and select the days to distribute it across.</p>
        <div>
            <label for="demo-hours" class="block text-sm font-medium text-gray-700">Total Demo Prep Hours</label>
            <input type="number" id="demo-hours" class="form-input mt-1" value="${currentHours || '1'}" step="0.5" min="0">
        </div>
        <div class="mt-4">
            <div class="flex justify-between items-center mb-2"><strong class="font-medium text-sm">Week 1</strong>${allWeekHtml(1)}</div>
            <div id="week-1-days" class="grid grid-cols-2 md:grid-cols-5 gap-2">${dayCheckboxHtml(1)}</div>
        </div>
        <div class="mt-4">
            <div class="flex justify-between items-center mb-2"><strong class="font-medium text-sm">Week 2</strong>${allWeekHtml(2)}</div>
            <div id="week-2-days" class="grid grid-cols-2 md:grid-cols-5 gap-2">${dayCheckboxHtml(2)}</div>
        </div>
        <div class="flex justify-end mt-6">
            <button id="confirm-demo-prep" class="px-4 py-2 bg-purple-600 text-white rounded-md">Distribute Time</button>
        </div>
    `, "Distribute Demo Prep Time");
    
    document.querySelectorAll('[data-action="select-all-week"]').forEach(btn => {
        btn.onchange = (e) => {
            const weekNum = e.target.dataset.week;
            const dayContainer = document.getElementById(`week-${weekNum}-days`);
            dayContainer.querySelectorAll('input[type="checkbox"]:not(:disabled)').forEach(cb => cb.checked = e.target.checked);
        };
    });

    document.getElementById('confirm-demo-prep').onclick = () => {
        const totalHours = parseFloat(document.getElementById('demo-hours').value);
        if (isNaN(totalHours) || totalHours < 0) { // Allow 0 hours
            return showMessageModal("Please enter a valid number of hours for demo prep.", "Input Required", null, "Back");
        }
        
        const selectedDays = Array.from(document.querySelectorAll('.demo-prep-day-cb:checked')).map(cb => cb.value);

        if (selectedDays.length === 0 && totalHours > 0) {
            return showMessageModal("Please select at least one day to distribute hours.", "Input Required", null, "Back");
        }
        
        sprint.tasks[demoTaskId].totalHours = totalHours;
        
        Object.keys(sprint.schedule).forEach(dayId => {
            sprint.schedule[dayId] = sprint.schedule[dayId].filter(t => t.taskId !== demoTaskId);
        });
        
        if (totalHours > 0 && selectedDays.length > 0) {
            const hoursPerDay = totalHours / selectedDays.length;
            let distributedTotal = 0;
            
            selectedDays.forEach((dayId, index) => {
                let hoursForThisDay = parseFloat(hoursPerDay.toFixed(2));
                if (index === selectedDays.length - 1) {
                    hoursForThisDay = totalHours - distributedTotal;
                }

                if (!sprint.schedule[dayId]) sprint.schedule[dayId] = [];
                sprint.schedule[dayId].push({
                    id: `s_${dayId}_${demoTaskId}_${Math.random()}`,
                    taskId: demoTaskId,
                    hours: hoursForThisDay
                });
                distributedTotal += hoursForThisDay;
            });
        }

        hideModal();
        renderApp();
    };
}


function showMoveOrDeleteTasksModal(originalDayId, tasksToMove) {
    const sprint = appState.sprints[appState.activeSprintId];
    const taskListHtml = tasksToMove.map(task => {
        const taskDef = sprint.tasks[task.taskId];
        return `<li class="text-sm">${taskDef.ticketId} - ${taskDef.name} (${task.hours.toFixed(2)}h)</li>`;
    }).join('');

    showActionModal({
        title: 'Tasks on Day Off',
        message: `<strong>${dayMeta[originalDayId].name}</strong> was set to a full day off. What should happen to its scheduled tasks? <br><ul class="list-disc list-inside my-4 bg-gray-50 p-3 rounded-md">${taskListHtml}</ul>`,
        buttons: [
            { label: "Cancel", class: "bg-gray-200", handler: () => {
                sprint.daysOff[originalDayId] = 'none'; // Revert change
                hideModal();
                renderApp();
            }},
            { label: "Delete All", class: "bg-red-600 text-white", handler: () => {
                delete sprint.schedule[originalDayId];
                hideModal();
                renderApp();
            }},
            { label: "Move All", class: "bg-indigo-600 text-white", handler: () => showMoveTasksTargetModal(tasksToMove, originalDayId) }
        ]
    });
}

function showHalfDayAdjustmentModal(dayId) {
    const sprint = appState.sprints[appState.activeSprintId];
    const newCapacity = sprint.dailyLimits[dayId];
    const tasksOnDay = sprint.schedule[dayId] || [];
    const scheduledHours = tasksOnDay.reduce((s, t) => s + t.hours, 0);
    const overage = scheduledHours - newCapacity;

    showActionModal({
        title: 'Adjust for Half Day',
        message: `<p class="mb-2"><strong>${dayMeta[dayId].name}</strong> is now a half day (${newCapacity.toFixed(2)}h). The currently scheduled ${scheduledHours.toFixed(2)}h exceeds this by <strong>${overage.toFixed(2)}h</strong>.</p>
                  <p class="mb-4">How do you want to adjust?</p>`,
        buttons: [
            { label: "Cancel", class: "bg-gray-200", handler: () => {
                sprint.daysOff[dayId] = 'none'; // Revert change
                handleDayStatusChange(dayId, 'none'); // Also reset capacity
            }},
            { label: "Adjust Manually", class: "bg-green-600 text-white", handler: hideModal },
            { label: "Auto-Reduce", class: "bg-blue-600 text-white", handler: () => {
                let reductionAmount = overage;
                tasksOnDay.sort((a,b) => b.hours - a.hours); // reduce from largest tasks first
                for(const task of tasksOnDay) {
                    if(reductionAmount <= 0) break;
                    const reduction = Math.min(task.hours, reductionAmount);
                    task.hours -= reduction;
                    reductionAmount -= reduction;
                }
                sprint.schedule[dayId] = tasksOnDay.filter(t => t.hours > 0.01);
                hideModal();
                renderApp();
            }}
        ]
    });
}


// --- GENERIC MODAL SYSTEM ---
function showModal(content, title = "") {
    const modal = document.getElementById('generic-modal');
    modal.innerHTML = `<div class="modal-content">
        <div class="flex justify-between items-start mb-4">
            <h2 class="text-lg font-semibold text-gray-800">${title}</h2>
            <button onclick="hideModal()" class="text-gray-400 hover:text-gray-600 z-10 p-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        <div>${content}</div>
    </div>`;
    modal.classList.remove('hidden');
    setTimeout(() => modal.classList.remove('opacity-0'), 10);
    return modal.querySelector('.modal-content div:last-child');
}
function hideModal() {
    const modal = document.getElementById('generic-modal');
    modal.classList.add('opacity-0');
    setTimeout(() => { modal.classList.add('hidden'); modal.innerHTML = ''; }, 300);
}
function showMessageModal(message, title = "Alert", onOk = hideModal, okLabel = "OK") {
    const modalContent = showModal(`
        <p class="text-sm text-gray-600">${message}</p>
        <div class="flex justify-end mt-6">
            <button id="ok-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md">${okLabel}</button>
        </div>
    `, title);
    modalContent.querySelector('#ok-btn').onclick = onOk || hideModal;
}
function showConfirmationModal(message, onConfirm, title = "Confirmation") {
    showActionModal({
        title: title,
        message: message,
        buttons: [
            { label: "Cancel", class: "bg-gray-200", handler: hideModal },
            { label: "Confirm", class: "bg-red-600 text-white", handler: () => {
                if(onConfirm) onConfirm();
                hideModal();
            }}
        ]
    });
}

function showActionModal({ title, message, buttons = [] }) {
    const buttonsHtml = buttons.map((btn, index) => 
        `<button id="action-btn-${index}" class="px-4 py-2 rounded-md ${btn.class || 'bg-gray-200'}">${btn.label}</button>`
    ).join('');

    const modalContent = showModal(`
        <div class="text-sm text-gray-600">${message}</div>
        <div class="flex justify-end mt-6 gap-3">${buttonsHtml}</div>
    `, title);

    buttons.forEach((btn, index) => {
        modalContent.querySelector(`#action-btn-${index}`).onclick = () => {
            if (btn.handler) btn.handler();
        };
    });
}

function showCalendarModal(title, onConfirm, onCancel = hideModal) {
    const today = new Date();
    const modalContent = showModal(`
        <div id="calendar-container" class="max-w-xs mx-auto"></div>
        <div class="flex justify-end mt-4">
            <button id="calendar-cancel-btn" class="px-4 py-2 bg-gray-200 rounded-md">Cancel</button>
        </div>
    `, title);
    const calendarContainer = modalContent.querySelector('#calendar-container');
    const calendar = generateCalendar(today.getFullYear(), today.getMonth(), (selectedDate) => {
        hideModal();
        onConfirm(selectedDate);
    });
    calendarContainer.appendChild(calendar);
    modalContent.querySelector('#calendar-cancel-btn').onclick = onCancel;
}

function generateCalendar(year, month, onDateSelect) {
    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    const calendarEl = document.createElement('div');
    const firstDayOfMonth = new Date(year, month, 1);
    const firstDayIndex = (firstDayOfMonth.getDay() + 6) % 7; 
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    let html = `
        <div class="flex justify-between items-center mb-4">
            <button id="prev-month" class="p-2 rounded-full hover:bg-gray-200">&lt;</button>
            <span class="font-semibold text-lg">${monthNames[month]} ${year}</span>
            <button id="next-month" class="p-2 rounded-full hover:bg-gray-200">&gt;</button>
        </div>
        <div class="grid grid-cols-7 text-center text-xs text-gray-500 mb-2 font-medium">
            <div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div><div>Su</div>
        </div>
        <div class="grid grid-cols-7 gap-1">`;
    html += `<div></div>`.repeat(firstDayIndex);
    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        if (date.getDay() === 1) { // 1 is Monday
             html += `<div class="p-2 text-center rounded-full cursor-pointer bg-blue-100 text-blue-800 hover:bg-indigo-200 transition-colors" data-date="${dateStr}">${day}</div>`;
        } else {
             html += `<div class="p-2 text-center text-gray-400 cursor-not-allowed">${day}</div>`;
        }
    }
    html += `</div>`;
    calendarEl.innerHTML = html;

    calendarEl.querySelector('#prev-month').onclick = () => {
        calendarEl.replaceWith(generateCalendar(month === 0 ? year - 1 : year, month === 0 ? 11 : month - 1, onDateSelect));
    };
    calendarEl.querySelector('#next-month').onclick = () => {
        calendarEl.replaceWith(generateCalendar(month === 11 ? year + 1 : year, month === 11 ? 0 : month + 1, onDateSelect));
    };
    calendarEl.querySelectorAll('[data-date]').forEach(el => el.onclick = () => onDateSelect(el.dataset.date));
    return calendarEl;
}

// --- NEW/UPDATED MOVE/SWAP & SLIDER LOGIC ---
function handleMoveTasksClick(dayId) {
    const sprint = appState.sprints[appState.activeSprintId];
    const selectedCheckboxes = document.querySelectorAll(`td[data-day-id="${dayId}"] .task-card-checkbox:checked`);
    let scheduledIdsToMove = Array.from(selectedCheckboxes).map(cb => cb.dataset.scheduledId);
    
    if (scheduledIdsToMove.length === 0) {
        // If no tasks are selected, select all tasks on that day
        const allTasksOnDay = sprint.schedule[dayId] || [];
        if (allTasksOnDay.length === 0) {
            showToast("No tasks on this day to move.", "info");
            return;
        }
        scheduledIdsToMove = allTasksOnDay.map(task => task.id);
    }
    
    const tasksToMove = scheduledIdsToMove.map(id => findScheduledTaskById(id).scheduledTask).filter(Boolean);
    if(tasksToMove.length > 0) {
        showMoveTasksTargetModal(tasksToMove, dayId);
    }
}

function showMoveTasksTargetModal(tasksToMove, originalDayId) {
    const sprint = appState.sprints[appState.activeSprintId];
    
    const generateDayButtons = (weekNum) => {
        return Object.keys(dayMeta)
            .filter(dayId => dayMeta[dayId].week === weekNum && sprint.daysOff[dayId] !== 'full' && dayId !== originalDayId)
            .map(dayId => {
                const dateDisplay = sprint.startDate ? `(${getDateForDayId(sprint.startDate, dayId).toLocaleDateString('en-US', { day: 'numeric' })})` : '';
                return `
                <label class="flex-1">
                    <input type="radio" name="move-target-day-radio" value="${dayId}" class="sr-only peer">
                    <div class="p-2 border rounded-md text-center cursor-pointer text-sm peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600 hover:bg-indigo-50">
                        <p class="font-semibold">${dayMeta[dayId].name.substring(0,3)}</p>
                        <p class="text-xs">${dateDisplay}</p>
                    </div>
                </label>`;
            }).join('');
    };

    const modalContent = showModal(`
        <p class="mb-4 text-center">Select a new day to move the task(s).</p>
        <div>
            <p class="text-sm font-semibold mb-2 text-gray-600">Week 1</p>
            <div class="flex gap-2">${generateDayButtons(1)}</div>
        </div>
        <div class="mt-4">
            <p class="text-sm font-semibold mb-2 text-gray-600">Week 2</p>
            <div class="flex gap-2">${generateDayButtons(2)}</div>
        </div>
        <div class="flex justify-end mt-6 gap-3">
            <button onclick="hideModal()" class="px-4 py-2 bg-gray-200 rounded-md">Cancel</button>
            <button id="confirm-move-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md">Confirm Move</button>
        </div>
    `, 'Select Target Day');
    
    modalContent.querySelector('#confirm-move-btn').onclick = () => {
        const targetDayId = modalContent.querySelector('input[name="move-target-day-radio"]:checked')?.value;
        if (!targetDayId) {
            showToast("Please select a target day.", "error");
            return;
        };
        executeMove(tasksToMove, originalDayId, targetDayId);
    };
}

function executeMove(tasksToMove, sourceDayId, targetDayId) {
    const sprint = appState.sprints[appState.activeSprintId];
    const totalHoursToMove = tasksToMove.reduce((sum, task) => sum + task.hours, 0);
    const scheduledOnTarget = (sprint.schedule[targetDayId] || []).reduce((sum, t) => sum + t.hours, 0);
    const targetCapacity = sprint.dailyLimits[targetDayId];
    const remainingCapacity = targetCapacity - scheduledOnTarget;

    if (totalHoursToMove > remainingCapacity + 0.01) {
        showAdjustAndMoveModal(tasksToMove, sourceDayId, targetDayId, remainingCapacity);
    } else {
        showSimpleMoveConfirmationModal(tasksToMove, sourceDayId, targetDayId);
    }
}

function showSimpleMoveConfirmationModal(tasksToMove, sourceDayId, targetDayId) {
    const totalHours = tasksToMove.reduce((sum, t) => sum + t.hours, 0);
    const message = `Are you sure you want to move ${tasksToMove.length} task(s) totaling ${totalHours.toFixed(2)}h to ${dayMeta[targetDayId].name}?`;
    
    showActionModal({
        title: "Confirm Move",
        message: message,
        buttons: [
            { label: "Cancel", class: "bg-gray-200", handler: hideModal },
            { label: "Confirm Move", class: "bg-indigo-600 text-white", handler: () => {
                confirmAndFinalizeMove(tasksToMove, sourceDayId, targetDayId);
            }}
        ]
    });
}

function confirmAndFinalizeMove(tasksToMove, sourceDayId, targetDayId) {
    const sprint = appState.sprints[appState.activeSprintId];
    
    if (!sprint.schedule[targetDayId]) sprint.schedule[targetDayId] = [];
    tasksToMove.forEach(task => {
        const existing = sprint.schedule[targetDayId].find(t => t.taskId === task.taskId);
        if (existing) {
            existing.hours += task.hours;
        } else {
            sprint.schedule[targetDayId].push({ ...task, id: `s_${targetDayId}_${task.taskId}_${Math.random()}` });
        }
    });

    if (sourceDayId) {
      const idsToMove = new Set(tasksToMove.map(t => t.id));
      sprint.schedule[sourceDayId] = sprint.schedule[sourceDayId].filter(t => !idsToMove.has(t.id));
      if (sprint.schedule[sourceDayId].length === 0) {
          delete sprint.schedule[sourceDayId];
      }
    }
    
    hideModal(); // Close any preceding modal (like confirmation or adjustment)
    renderApp();
    showToast(`${tasksToMove.length} task(s) moved successfully.`, 'success');
}


function showAdjustAndMoveModal(tasksToMove, sourceDayId, targetDayId, remainingCapacity) {
    const totalHoursToMove = tasksToMove.reduce((sum, task) => sum + task.hours, 0);
    const message = `Moving <strong>${totalHoursToMove.toFixed(2)}h</strong> will exceed the <strong>${remainingCapacity > 0 ? remainingCapacity.toFixed(2) : '0.00'}h</strong> available on ${dayMeta[targetDayId].name}.`;

    const buttons = [
        { label: "Cancel", class: "bg-gray-200", handler: hideModal },
        { label: "Pick Another Day", class: "bg-yellow-500 text-white", handler: () => {
            showMoveTasksTargetModal(tasksToMove, sourceDayId);
        }}
    ];

    if (remainingCapacity > 0.01) {
        buttons.push({ 
            label: `Auto-reduce & Move (${remainingCapacity.toFixed(2)}h)`, 
            class: "bg-blue-600 text-white", 
            handler: () => {
                let hoursToDistribute = remainingCapacity;
                const adjustedTasks = tasksToMove.map(task => ({...task})); 
                
                adjustedTasks.forEach(task => {
                    task.hours = (task.hours / totalHoursToMove) * hoursToDistribute;
                });
                
                let currentTotal = adjustedTasks.reduce((sum, t) => sum + t.hours, 0);
                if(adjustedTasks.length > 0) {
                    adjustedTasks[0].hours += hoursToDistribute - currentTotal;
                }
                
                confirmAndFinalizeMove(adjustedTasks.filter(t => t.hours > 0.01), sourceDayId, targetDayId);
            }
        });
    }

    showActionModal({
        title: "Not Enough Capacity",
        message: `${message}<br><br>How would you like to proceed?`,
        buttons: buttons
    });
}

function setupStatusSlider(slider) {
    const thumb = slider.querySelector('.status-slider-thumb');
    let isDragging = false;
    const states = ['full', 'none', 'half'];
    const statePositions = { full: 0, none: 0.5, half: 1 };
    
    const updateThumbPosition = (state) => {
        const percent = statePositions[state];
        const sliderWidth = slider.offsetWidth;
        const thumbWidth = thumb.offsetWidth;
        thumb.style.left = `${percent * (sliderWidth - thumbWidth)}px`;

        const textEl = slider.querySelector('.status-slider-text');
        const placeholderEl = slider.querySelector('.status-slider-placeholders');

        if(state === 'none'){
            textEl.style.opacity = '0';
            placeholderEl.style.opacity = '1';
        } else {
            textEl.textContent = state.toUpperCase();
            textEl.style.opacity = '1';
            placeholderEl.style.opacity = '0';
        }
    };

    const setNewState = (newState) => {
        if (slider.dataset.state !== newState) {
            handleDayStatusChange(slider.dataset.dayId, newState);
        }
    };
    
    const handleEnd = (e) => {
        if (!isDragging) return;
        isDragging = false;
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        document.removeEventListener('touchmove', onTouchMove);
        document.removeEventListener('touchend', onTouchEnd);

        const rect = slider.getBoundingClientRect();
        const thumbRect = thumb.getBoundingClientRect();
        const thumbCenter = thumbRect.left - rect.left + thumb.offsetWidth / 2;
        const percent = thumbCenter / rect.width;
        
        let newState = 'none';
        if (percent < 0.33) newState = 'full';
        else if (percent > 0.66) newState = 'half';
        
        setNewState(newState);
        setTimeout(() => renderApp(), 50);
    };

    const handleMove = (clientX) => {
        if (!isDragging) return;
        const rect = slider.getBoundingClientRect();
        let newLeft = clientX - rect.left - thumb.offsetWidth / 2;
        newLeft = Math.max(-2, Math.min(newLeft, rect.width - thumb.offsetWidth + 2));
        thumb.style.left = `${newLeft}px`;
        
        const textEl = slider.querySelector('.status-slider-text');
        if (textEl) textEl.style.opacity = '0';
        
        const placeholderEl = slider.querySelector('.status-slider-placeholders');
        if(placeholderEl) placeholderEl.style.opacity = '0';
    };

    const onMouseDown = (e) => { isDragging = true; document.addEventListener('mousemove', onMouseMove); document.addEventListener('mouseup', onMouseUp); };
    const onMouseMove = (e) => { handleMove(e.clientX); };
    const onMouseUp = (e) => { handleEnd(e); };
    
    const onTouchStart = (e) => { isDragging = true; document.addEventListener('touchmove', onTouchMove); document.addEventListener('touchend', onTouchEnd); };
    const onTouchMove = (e) => { handleMove(e.touches[0].clientX); };
    const onTouchEnd = (e) => { handleEnd(e); };

    thumb.addEventListener('mousedown', onMouseDown);
    thumb.addEventListener('touchstart', onTouchStart, { passive: true });

    slider.addEventListener('click', (e) => {
        if (e.target.classList.contains('status-slider-thumb')) return;
        const rect = slider.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const percent = clickX / rect.width;
        let newState = 'none';
        if (percent < 0.33) newState = 'full';
        else if (percent > 0.66) newState = 'half';
        setNewState(newState);
    });
    
    updateThumbPosition(slider.dataset.state);
}

function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast-notification toast-${type}`;
    
    const iconSvg = {
        success: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
        info: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
        error: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`
    }

    toast.innerHTML = `${iconSvg[type] || ''} <span>${message}</span>`;
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('show');
    }, 10);

    setTimeout(() => {
        toast.classList.remove('show');
        toast.addEventListener('transitionend', () => toast.remove());
    }, 3000);
}


function showConfirmDefaultTimesModal(parsedTasks, sprintName) {
    const dayInputsHtml = Object.keys(dayMeta).map(dayId => `
        <div class="flex items-center justify-between">
            <label for="capacity-${dayId}" class="text-sm font-medium text-gray-700">${dayMeta[dayId].name} (W${dayMeta[dayId].week})</label>
            <input id="capacity-${dayId}" type="number" class="form-input w-24 text-right" value="${INITIAL_DAILY_LIMITS[dayId]}" step="0.25" min="0">
        </div>
    `).join('');

    const modalContent = showModal(`
        <p class="text-sm text-gray-600 mb-4">Please confirm or update the default daily capacities for this new sprint.</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-3">${dayInputsHtml}</div>
        <div class="flex justify-end mt-6">
             <button id="cancel-create-btn" class="px-4 py-2 bg-gray-200 rounded-md">Cancel</button>
             <button id="confirm-capacity-btn" class="ml-3 px-4 py-2 bg-indigo-600 text-white rounded-md">Create Sprint</button>
        </div>
    `, "Confirm Daily Capacities");

    modalContent.querySelector('#cancel-create-btn').onclick = hideModal;
    modalContent.querySelector('#confirm-capacity-btn').onclick = () => {
        const sprintNumber = parseInt(sprintName.match(/\d+/)[0]);
        const newDailyLimits = {};
        Object.keys(dayMeta).forEach(dayId => {
            const input = document.getElementById(`capacity-${dayId}`);
            newDailyLimits[dayId] = parseFloat(input.value) || 0;
        });

        const newSprint = createSprintFromParsedTasks(parsedTasks, sprintName, newDailyLimits);
        const newSprintId = `sprint-${Date.now()}`;
        appState.sprints[newSprintId] = newSprint;
        appState.activeSprintId = newSprintId;
        if (!isNaN(sprintNumber)) {
            appState.uiState.lastSprintNumber = sprintNumber;
        }
        hideModal();
        renderApp();
    };
}

// --- TICKET MANAGEMENT (NEW/ENHANCED) ---
function showManageTicketsModal() {
    let activeView = 'fields'; // 'fields' or 'raw'
    const sprint = appState.sprints[appState.activeSprintId];
    let tempTickets = getBaseTickets(sprint);

    const render = () => {
        const container = document.getElementById('manage-tickets-container');
        if (!container) return;

        let contentHtml = '';
        if (activeView === 'fields') {
            const rowsHtml = tempTickets.map((ticket, index) => `
                <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                    <td class="p-2 border"><input type="text" class="form-input" value="${ticket.ticketId}" data-index="${index}" data-field="ticketId"></td>
                    <td class="p-2 border"><input type="text" class="form-input" value="${ticket.title}" data-index="${index}" data-field="title"></td>
                    <td class="p-2 border"><input type="number" class="form-input w-20 text-center" value="${ticket.points}" data-index="${index}" data-field="points"></td>
                    <td class="p-2 border text-center">${(ticket.points * HOURS_PER_POINT).toFixed(2)}h</td>
                    <td class="p-2 border"><input type="text" class="form-input w-16 text-center" value="${ticket.type}" data-index="${index}" data-field="type"></td>
                </tr>
            `).join('');
            contentHtml = `<table class="w-full text-sm border-collapse">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="p-2 border text-left">Ticket ID</th>
                        <th class="p-2 border text-left">Title</th>
                        <th class="p-2 border text-left">Points</th>
                        <th class="p-2 border text-left">Est. Hours</th>
                        <th class="p-2 border text-left">Type (S/B)</th>
                    </tr>
                </thead>
                <tbody>${rowsHtml}</tbody>
            </table>`;
        } else { // raw view
            contentHtml = `<textarea id="ticket-text-bulk" class="w-full h-80 p-2 border rounded-md font-mono text-xs" placeholder="Example:\nNCOP-9382\tBug - [UAT] Incorrect Logic\t5\tB\nNCOP-9879\tEnhance scalar function\t8\tS">${convertTicketsToText(tempTickets)}</textarea>`;
        }
        container.innerHTML = contentHtml;
    };
    
    const modalContent = showModal(`
        <div class="flex justify-end mb-2">
            <div class="flex p-1 bg-gray-200 rounded-lg">
                <button id="view-fields-btn" class="px-3 py-1 text-sm rounded-md">Fields</button>
                <button id="view-raw-btn" class="px-3 py-1 text-sm rounded-md">Raw Text</button>
            </div>
        </div>
        <div id="manage-tickets-container"></div>
        <div class="mt-4 flex justify-end items-center">
            <div class="flex gap-3">
                <button onclick="hideModal()" class="px-4 py-2 bg-gray-200 rounded-md">Cancel</button>
                <button id="save-ticket-changes-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md">Save and Apply Changes</button>
            </div>
        </div>
    `, `Manage Tickets for ${sprint.sprintName}`);

    const viewFieldsBtn = modalContent.querySelector('#view-fields-btn');
    const viewRawBtn = modalContent.querySelector('#view-raw-btn');

    const setActiveView = (view) => {
        activeView = view;
        if (view === 'fields') {
            viewFieldsBtn.classList.add('bg-white', 'shadow');
            viewRawBtn.classList.remove('bg-white', 'shadow');
            // Before rendering fields, parse raw text if it was the last view
            const textArea = document.getElementById('ticket-text-bulk');
            if (textArea) {
                try {
                    tempTickets = parsePastedText(textArea.value);
                } catch (e) {
                    showToast("Error parsing raw text. Check for formatting errors.", "error");
                }
            }
        } else {
            viewRawBtn.classList.add('bg-white', 'shadow');
            viewFieldsBtn.classList.remove('bg-white', 'shadow');
        }
        render();
    };
    
    viewFieldsBtn.onclick = () => setActiveView('fields');
    viewRawBtn.onclick = () => setActiveView('raw');

    modalContent.addEventListener('input', e => {
        const target = e.target.closest('[data-index]');
        if (target) {
            const { index, field } = target.dataset;
            const value = field === 'points' ? (parseInt(target.value, 10) || 0) : target.value;
            tempTickets[index][field] = value;
            if (field === 'points') {
                render();
            }
        }
    });

    modalContent.querySelector('#save-ticket-changes-btn').onclick = () => {
        if (activeView === 'raw') {
            const textArea = document.getElementById('ticket-text-bulk');
            try {
                tempTickets = parsePastedText(textArea.value);
            } catch (e) {
                return showMessageModal(`Failed to parse text: ${e.message}`, "Parsing Error");
            }
        }
        updateSprintTickets(sprint, tempTickets);
        hideModal();
        renderApp();
    };

    setActiveView('fields'); // Initial view
}

function getBaseTickets(sprint) {
    const tickets = {};
    Object.values(sprint.tasks).forEach(task => {
        if (task.ticketId && task.ticketId !== 'N/A' && task.ticketId !== 'DEMO_PREP') {
            if (!tickets[task.ticketId]) {
                 tickets[task.ticketId] = {
                    ticketId: task.ticketId,
                    title: task.title,
                    points: task.points || 0,
                    type: (task.name === 'Verify Bug' ? 'B' : 'S')
                };
            }
        }
    });
    return Object.values(tickets).sort((a,b) => a.ticketId.localeCompare(b.ticketId));
}

function convertTicketsToText(tickets) {
    return tickets.map(t => `${t.ticketId}\t${t.title}\t${t.points}\t${t.type}`).join('\n');
}

function updateSprintTickets(sprint, updatedTickets) {
    const originalTickets = getBaseTickets(sprint);

    const originalTicketMap = new Map(originalTickets.map(t => [t.ticketId, t]));
    const updatedTicketMap = new Map(updatedTickets.map(t => [t.ticketId, t]));

    // 1. Handle Deletions
    for (const [ticketId, originalTicket] of originalTicketMap.entries()) {
        if (!updatedTicketMap.has(ticketId)) {
            const subTaskIdsToDelete = Object.entries(sprint.tasks)
                .filter(([_, task]) => task.ticketId === ticketId)
                .map(([id, _]) => id);

            subTaskIdsToDelete.forEach(taskId => {
                delete sprint.tasks[taskId];
                Object.keys(sprint.schedule).forEach(dayId => {
                    sprint.schedule[dayId] = sprint.schedule[dayId].filter(log => log.taskId !== taskId);
                });
                sprint.exceededLogs = sprint.exceededLogs.filter(log => log.fromTaskId !== taskId);
            });
        }
    }

    // 2. Handle Additions and Updates
    for (const [ticketId, updatedTicket] of updatedTicketMap.entries()) {
        const originalTicket = originalTicketMap.get(ticketId);

        if (!originalTicket) {
            // New ticket
            const newSubTasks = generateSubTasksForTicket(updatedTicket);
            Object.assign(sprint.tasks, newSubTasks);
        } else {
            // Existing ticket, check for changes
            const hasChanged = originalTicket.title !== updatedTicket.title ||
                               originalTicket.points !== updatedTicket.points ||
                               originalTicket.type !== updatedTicket.type;

            if (hasChanged) {
                // Easiest way to handle type change (e.g. Story to Bug) is to delete and re-add
                const subTaskIdsToDelete = Object.entries(sprint.tasks)
                    .filter(([_, task]) => task.ticketId === ticketId)
                    .map(([id, _]) => id);
                
                subTaskIdsToDelete.forEach(taskId => {
                    delete sprint.tasks[taskId];
                    // keep logs for now, they will be re-assigned or handled by point update
                });

                const newSubTasks = generateSubTasksForTicket(updatedTicket);
                Object.assign(sprint.tasks, newSubTasks);
                updateTicketPoints(sprint, updatedTicket.ticketId, updatedTicket.points);
            }
        }
    }
    showToast("Sprint tickets updated successfully!", "success");
}


function updateTicketPoints(sprint, ticketId, newPoints) {
    const newTotalHours = newPoints * HOURS_PER_POINT;
    
    const subTaskEntries = Object.entries(sprint.tasks).filter(([_, task]) => task.ticketId === ticketId);
    const subTaskIds = subTaskEntries.map(([id, _]) => id);

    // 1. Calculate currently logged hours for all sub-tasks of this ticket
    let currentlyLogged = 0;
    Object.values(sprint.schedule).flat().forEach(log => {
        if (subTaskIds.includes(log.taskId)) {
            currentlyLogged += log.hours;
        }
    });

    // 2. Update the estimated hours for each sub-task
    if (subTaskEntries.length === 1 && subTaskEntries[0][1].name === 'Verify Bug') { // It's a Bug
        subTaskEntries[0][1].totalHours = newTotalHours;
        subTaskEntries[0][1].points = newPoints;
    } else { // It's a Story
        subTaskEntries.forEach(([id, task]) => {
            const distribution = STORY_SUBTASK_DISTRIBUTION.find(d => d.name === task.name);
            if (distribution) {
                task.totalHours = newTotalHours * (distribution.percentage / 100);
            }
            task.points = newPoints;
        });
    }

    // 3. Handle over-logging if points were reduced
    if (currentlyLogged > newTotalHours) {
        let overLoggedHours = currentlyLogged - newTotalHours;
        
        // Find all scheduled logs for these subtasks
        const allLogs = [];
        dayIdsReverseChronological.forEach(dayId => {
            if (sprint.schedule[dayId]) {
                sprint.schedule[dayId].forEach(log => {
                    if (subTaskIds.includes(log.taskId)) {
                        allLogs.push({ ...log, dayId });
                    }
                });
            }
        });

        // Reduce from the latest logs first
        for (const log of allLogs) {
            if (overLoggedHours <= 0) break;
            
            const reductionAmount = Math.min(log.hours, overLoggedHours);
            const scheduledLogInSprint = sprint.schedule[log.dayId].find(l => l.id === log.id);
            
            if (scheduledLogInSprint) {
                 scheduledLogInSprint.hours -= reductionAmount;
                 overLoggedHours -= reductionAmount;
            }
        }
        
        // Clean up logs with zero hours
        Object.keys(sprint.schedule).forEach(dayId => {
            sprint.schedule[dayId] = sprint.schedule[dayId].filter(log => log.hours > 0.01);
            if (sprint.schedule[dayId].length === 0) {
                delete sprint.schedule[dayId];
            }
        });

        showToast(`Points reduced. Automatically adjusted ${ (currentlyLogged - newTotalHours).toFixed(2) }h from scheduled logs.`, 'info');
    }
}


// --- INITIALIZATION ---
window.onload = () => { 
    loadState();
    renderApp();
};
</script>
</body>
</html>
