<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Interactive Sprint Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .task-card {
            display: flex; flex-direction: column; 
            padding: 8px 12px; border-radius: 8px;
            margin-bottom: 8px; border: 1px solid; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            cursor: grab;
        }
        .task-card-text {
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .task-card.dragging { opacity: 0.5; }
        .day-column.drag-over { background-color: #eef2ff; }
        .task-create { background-color: #dcfce7; border-color: #bbf7d0; color: #166534; }
        .task-execute { background-color: #dbeafe; border-color: #bfdbfe; color: #1e40af; }
        .task-verify { background-color: #fee2e2; border-color: #fecaca; color: #991b1b; }
        .task-demo { background-color: #fef9c3; border-color: #fef08a; color: #854d0e; }
        
        .th-day-off-full { background-color: #fee2e2 !important; }
        .th-day-off-half { background-color: #fef3c7 !important; }
        .day-column.day-off-full { background-color: #fef2f2; }
        .day-column.day-off-half { background-image: linear-gradient(180deg, #fefce8 50%, transparent 50%); }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 50; transition: opacity 0.3s; }
        .modal-content { background-color: white; padding: 24px; border-radius: 8px; max-width: 800px; width: 95%; max-height: 90vh; overflow-y: auto; transform: scale(0.95); transition: transform 0.3s; position: relative;}
        .modal-overlay:not(.hidden) .modal-content { transform: scale(1); }
        .tab { padding: 8px 16px; cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap; }
        .tab.active { border-bottom-color: #4f46e5; color: #4f46e5; font-weight: 600; }
        .form-input { width: 100%; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; }
        
        .day-column { border-left: 1px solid #e5e7eb; vertical-align: top; position: relative; }
        .day-action-btn {
            padding: 6px; border-radius: 6px; background-color: #f9fafb;
            border: 1px solid #e5e7eb; transition: background-color 0.2s; cursor: pointer;
        }
        .day-action-btn:hover { background-color: #f3f4f6; }
        .day-action-btn:disabled { cursor: not-allowed; opacity: 0.5; }
        
        .capacity-bar { height: 6px; background-color: #e5e7eb; border-radius: 3px; overflow: hidden; }
        .capacity-bar-inner { height: 100%; border-radius: 3px; transition: width 0.3s; }
        
        .capacity-input {
            border: 1px solid transparent; text-align: center; font-weight: 500;
            padding: 2px 4px; border-radius: 4px; transition: all 0.2s;
            background-color: #f9fafb;
        }
        .capacity-input:hover, .capacity-input:focus { border-color: #a5b4fc; background-color: #eef2ff; }
        .capacity-input.changed { background-color: #dcfce7 !important; border-color: #34d399; }

        /* New Status Toggle UI */
        .status-toggle {
            position: relative; width: 100px; height: 28px; border-radius: 14px; display: flex;
            align-items: center; cursor: pointer;
            background-color: #e5e7eb;
            box-shadow: inset 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }
        .status-toggle-thumb {
            position: absolute; width: calc(33.33% - 2px); height: 24px;
            border-radius: 12px; box-shadow: 0 1px 3px rgb(0 0 0 / 0.2);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            top: 2px; left: 2px; z-index: 10;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 700;
        }
        .status-toggle-placeholder {
            flex: 1; text-align: center; font-size: 10px; color: #6b7280; font-weight: 500;
        }
        .status-toggle[data-state="full"] .status-toggle-thumb { transform: translateX(0%); background-color: #f87171; color: white;}
        .status-toggle[data-state="none"] .status-toggle-thumb { transform: translateX(100%); background-color: #34d399; color: white;}
        .status-toggle[data-state="half"] .status-toggle-thumb { transform: translateX(200%); background-color: #fbbf24; color: white;}

    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-screen-2xl mx-auto">
        <div id="tabs-container" class="flex border-b border-gray-200 mb-4 overflow-x-auto"></div>
        <div id="sprint-content"></div>
    </div>
    
    <div id="generic-modal" class="modal-overlay hidden opacity-0"></div>
    
<script>
// --- GLOBAL STATE & CONSTANTS ---
var APP_DATA_KEY = 'multiSprintPlannerState_v24_final';
let appState = { 
    activeSprintId: null, 
    sprints: {},
    uiState: {
        lastAddTaskTab: 'Create TCs',
        lastSprintNumber: 0
    }
};

var dayMeta = {
    w1d1: { week: 1, name: 'Monday' }, w1d2: { week: 1, name: 'Tuesday' }, w1d3: { week: 1, name: 'Wednesday' },
    w1d4: { week: 1, name: 'Thursday' }, w1d5: { week: 1, name: 'Friday' },
    w2d1: { week: 2, name: 'Monday' }, w2d2: { week: 2, name: 'Tuesday' }, w2d3: { week: 2, name: 'Wednesday' },
    w2d4: { week: 2, name: 'Thursday' }, w2d5: { week: 2, name: 'Friday' }
};
var dayOffsets = {
    w1d1: 0, w1d2: 1, w1d3: 2, w1d4: 3, w1d5: 4,
    w2d1: 7, w2d2: 8, w2d3: 9, w2d4: 10, w2d5: 11
};

// --- STATE MANAGEMENT ---
function saveState() {
    try {
        localStorage.setItem(APP_DATA_KEY, JSON.stringify(appState));
    } catch (e) {
        console.error("Failed to save state:", e);
        showMessageModal("Error: Could not save your changes to the browser's local storage.");
    }
}

function loadState() {
    try {
        const savedState = localStorage.getItem(APP_DATA_KEY);
        if (savedState) {
            const loaded = JSON.parse(savedState);
            appState = { ...appState, ...loaded };
            // Ensure uiState exists with default values
            appState.uiState = appState.uiState || {};
            appState.uiState.lastAddTaskTab = appState.uiState.lastAddTaskTab || 'Create TCs';
            appState.uiState.lastSprintNumber = appState.uiState.lastSprintNumber || 0;

            Object.values(appState.sprints).forEach(sprint => {
                if (!sprint.exceededLogs) sprint.exceededLogs = [];
                if (!sprint.schedule) sprint.schedule = {};
                if (!sprint.daysOff) sprint.daysOff = Object.keys(dayMeta).reduce((acc, dayId) => ({...acc, [dayId]: 'none'}), {});
                if (!sprint.defaultDailyLimits) sprint.defaultDailyLimits = createNewSprintState('').dailyLimits;
            });
        }
        if (!appState.sprints || Object.keys(appState.sprints).length === 0) {
             const defaultSprintId = `sprint-${Date.now()}`;
            appState.sprints = { [defaultSprintId]: createNewSprintState("Sample Sprint") };
            appState.activeSprintId = defaultSprintId;
        }
    } catch (e) {
        console.error("Failed to load or parse saved state. Resetting to default.", e);
        const defaultSprintId = `sprint-${Date.now()}`;
        appState = {
            activeSprintId: defaultSprintId,
            sprints: { [defaultSprintId]: createNewSprintState("Sample Sprint") },
            uiState: { lastAddTaskTab: 'Create TCs', lastSprintNumber: 0 }
        };
    }
}

// --- CORE RENDERING LOGIC ---
function renderApp() {
    if (!appState.activeSprintId || !appState.sprints[appState.activeSprintId]) {
        appState.activeSprintId = Object.keys(appState.sprints)[0] || null;
    }
    renderTabs();
    if(appState.activeSprintId) {
        renderSprintContent(appState.activeSprintId);
    }
    saveState();
}

function renderTabs() {
    const tabsContainer = document.getElementById('tabs-container');
    tabsContainer.innerHTML = '';
    Object.keys(appState.sprints).forEach(sprintId => {
        const sprint = appState.sprints[sprintId];
        const tab = document.createElement('div');
        tab.className = `tab ${sprintId === appState.activeSprintId ? 'active' : ''}`;
        tab.textContent = sprint.sprintName;
        tab.onclick = () => switchTab(sprintId);
        tabsContainer.appendChild(tab);
    });

    const addTabButton = document.createElement('button');
    addTabButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg> Add Sprint`;
    addTabButton.className = 'ml-4 my-1 px-3 py-1.5 text-sm bg-indigo-100 text-indigo-700 rounded-md hover:bg-indigo-200 flex items-center';
    addTabButton.onclick = showNewSprintDialog;
    tabsContainer.appendChild(addTabButton);

    const deleteSprintButton = document.createElement('button');
    deleteSprintButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg> Delete Sprint`;
    deleteSprintButton.className = 'ml-2 my-1 px-3 py-1.5 text-sm bg-red-100 text-red-700 rounded-md hover:bg-red-200 flex items-center';
    deleteSprintButton.onclick = handleDeleteSprint;
    tabsContainer.appendChild(deleteSprintButton);
}

function renderSprintContent(sprintId) {
    const sprint = appState.sprints[sprintId];
    if (!sprint) return;

    const container = document.getElementById('sprint-content');
    container.innerHTML = `
        <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
            <input type="text" value="${sprint.sprintName}" oninput="updateSprintName(this.value)" class="text-2xl font-bold text-gray-800 bg-transparent border-b-2 border-transparent focus:border-indigo-500 outline-none w-auto max-w-full">
        </div>
        <div id="sprint-dashboard" class="mb-6"></div>
        <div class="mb-10" data-week="1"></div>
        <div data-week="2"></div>`;
    
    renderWeek(sprint, 1);
    renderWeek(sprint, 2);
    renderDashboard(sprint);
    addSprintContentEventListeners();
}

function renderWeek(sprint, weekNumber) {
    const container = document.querySelector(`[data-week="${weekNumber}"]`);
    if(!container) return;

    const hasExceededLogs = (sprint.exceededLogs || []).some(log => dayMeta[log.dayLogged]?.week === weekNumber);

    let weekTitleHtml = `<h2 class="text-xl font-semibold text-gray-700">Week ${weekNumber}</h2>`;

    let weekButtons = '';
    if (!sprint.startDate && weekNumber === 1) {
        weekButtons += `<button data-action="set-start-date" class="px-3 py-1 text-sm bg-blue-100 text-blue-800 rounded-md hover:bg-blue-200 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
            Set Start Date
        </button>`;
    }
    if (hasExceededLogs) {
        weekButtons += `<button data-action="show-exceeded" data-week="${weekNumber}" class="px-3 py-1 text-sm bg-yellow-100 text-yellow-800 rounded-md hover:bg-yellow-200 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
            Exceeded Logs
        </button>`;
    }
    weekButtons += `<button data-action="dist-demo-prep" class="px-3 py-1 text-sm bg-purple-100 text-purple-800 rounded-md hover:bg-purple-200 flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M6 10a2 2 0 11-4 0 2 2 0 014 0zM12 10a2 2 0 11-4 0 2 2 0 014 0zM16 12a2 2 0 100-4 2 2 0 000 4z" /></svg>
        Demo Prep
    </button>`;

    container.innerHTML = `
        <div class="flex items-center justify-between mb-4">
            ${weekTitleHtml}
            <div class="flex items-center gap-2">${weekButtons}</div>
        </div>
        <div class="overflow-x-auto bg-white rounded-lg shadow">${generateWeekHtml(Object.keys(dayMeta).filter(d => dayMeta[d].week === weekNumber), sprint)}</div>
    `;
}


function generateWeekHtml(days, sprint) {
    const headHtml = days.map(dayId => {
        const scheduledHours = (sprint.schedule[dayId] || []).reduce((sum, t) => sum + t.hours, 0);
        const capacity = sprint.dailyLimits[dayId];
        const dayOffStatus = sprint.daysOff[dayId] || 'none';
        
        const percentage = capacity > 0 ? (scheduledHours / capacity) * 100 : 0;
        let barColor = 'bg-blue-500';
        if (percentage > 100) barColor = 'bg-red-500';
        else if (percentage > 85) barColor = 'bg-yellow-500';

        let dateDisplay = sprint.startDate ? `, ${getDateForDayId(sprint.startDate, dayId).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}` : '';
        
        const dayHeaderClass = dayOffStatus === 'full' ? 'th-day-off-full' : (dayOffStatus === 'half' ? 'th-day-off-half' : '');
        
        const statusText = dayOffStatus === 'full' ? 'OFF' : dayOffStatus === 'half' ? 'HALF' : 'ON';

        return `<th class="p-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider w-1/5 ${dayHeaderClass}" data-day-header-id="${dayId}">
            <div class="flex justify-between items-center">
                 <span class="font-semibold text-gray-700 normal-case whitespace-nowrap">${dayMeta[dayId].name}${dateDisplay}</span>
                 <div class="status-toggle" data-day-id="${dayId}" data-state="${dayOffStatus}">
                    <div class="status-toggle-placeholder" data-value="full" style="opacity: ${dayOffStatus === 'full' ? '0' : '1'}">OFF</div>
                    <div class="status-toggle-placeholder" data-value="none" style="opacity: ${dayOffStatus === 'none' ? '0' : '1'}">ON</div>
                    <div class="status-toggle-placeholder" data-value="half" style="opacity: ${dayOffStatus === 'half' ? '0' : '1'}">HALF</div>
                    <div class="status-toggle-thumb">
                        <span>${statusText}</span>
                    </div>
                </div>
            </div>
            <div class="capacity-bar my-2">
                <div class="capacity-bar-inner ${barColor}" style="width: ${Math.min(100, percentage)}%;"></div>
            </div>
            <div class="flex justify-center items-center text-base p-1 border border-gray-200 rounded-md">
                <span class="font-semibold ${percentage > 100 ? 'text-red-600' : 'text-gray-800'}">${scheduledHours.toFixed(2)}h</span>
                <span class="text-gray-400 mx-2">/</span>
                <input type="number" class="capacity-input w-16" data-day-id="${dayId}" value="${capacity.toFixed(2)}" step="0.25" min="0">
            </div>
        </th>`;
    }).join('');
    
    let bodyHtml = '<tr>' + days.map(dayId => {
        const tasksOnDay = sprint.schedule[dayId] || [];
        const dayOffStatus = sprint.daysOff[dayId] || 'none';
        const taskCards = tasksOnDay.map(st => {
            const ti = sprint.tasks[st.taskId];
            if (!ti) return '';
            const ticketIdSimple = ti.ticketId.replace(/^NCOP-/, '');
            const cardText = `${ticketIdSimple} - ${ti.name}`;
            return `
                <div class="task-card ${'task-' + ti.type}" data-scheduled-id="${st.id}" draggable="true" title="${ti.ticketId} - ${ti.name} - ${st.hours.toFixed(2)}h">
                    <div class="w-full">
                        <div class="task-card-text text-sm font-medium">${cardText}</div>
                        <div class="flex justify-between items-center mt-2 pt-1 border-t border-black border-opacity-10">
                            <span class="text-sm font-bold">${st.hours.toFixed(2)}h</span>
                            <div class="flex items-center">
                                <button class="day-action-btn" data-action="edit-single-task" data-scheduled-id="${st.id}" title="Edit Hours">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-600" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                                </button>
                                <button class="day-action-btn" data-action="delete-single-task" data-scheduled-id="${st.id}" title="Delete Task">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
        }).join('');

        const dayColumnClass = dayOffStatus === 'full' ? 'day-off-full' : (dayOffStatus === 'half' ? 'day-off-half' : '');
        
        return `<td class="p-2 align-top day-column ${dayColumnClass}" data-day-id="${dayId}">
            <div class="min-h-[100px]">${taskCards}</div>
            <div class="flex justify-center gap-2 mt-1">
                <button class="day-action-btn" data-action="add-day-task" data-day-id="${dayId}" title="Add Task to Day" ${dayOffStatus === 'full' ? 'disabled' : ''}>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
                </button>
                <button class="day-action-btn" data-action="delete-day-tasks" data-day-id="${dayId}" title="Delete All Tasks" ${tasksOnDay.length === 0 ? 'disabled' : ''}>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                </button>
            </div>
        </td>`;
    }).join('') + '</tr>';

    return `<table class="w-full min-w-[1200px] border-collapse table-fixed"><thead><tr>${headHtml}</tr></thead><tbody class="divide-y divide-gray-200">${bodyHtml}</tbody></table>`;
}

function renderDashboard(sprint) {
    const dashboard = document.getElementById('sprint-dashboard');
    const { storySummary, bugSummary } = getTaskSummaries(sprint);
    const { totalScheduled } = getAvailableTasks(sprint);

    let storyHtml = Object.entries(storySummary).map(([ticketId, story]) => {
        return `
            <div class="border rounded-md p-3 bg-green-50 border-green-200">
                <div class="flex justify-between items-baseline"><a href="https://oneline.atlassian.net/browse/${ticketId}" target="_blank" class="font-medium text-gray-800 hover:underline">${ticketId}</a></div>
                <p class="text-xs text-gray-600 mt-1 mb-2">${story.title || 'Story'}</p>
                <div class="text-xs space-y-1 border-t border-green-200 pt-2">
                    <div class="grid grid-cols-3 font-bold text-gray-500"><span>Sub-task</span><span class="text-right">Est.</span><span class="text-right">Logged</span></div>
                    ${Object.entries(story.subTasks).map(([subTaskId, hours]) => {
                        const logged = totalScheduled[subTaskId] || 0;
                        const logColor = logged > hours ? 'text-red-600 font-bold' : 'text-gray-700';
                        return `
                        <div class="grid grid-cols-3">
                            <span>${sprint.tasks[subTaskId].name}</span>
                            <span class="font-mono text-right">${hours.toFixed(2)}h</span>
                            <span class="font-mono text-right ${logColor}">${logged.toFixed(2)}h</span>
                        </div>`
                    }).join('')}
                </div>
            </div>`;
    }).join('');

    let bugHtml = '';
    if (Object.keys(bugSummary).length > 0) {
        bugHtml = `
        <div class="border rounded-md p-3 bg-red-50 border-red-200">
            <strong class="font-medium text-red-800 mb-2 block">Bugs</strong>
            <div class="text-xs space-y-1 border-t border-red-200 pt-2">
                <div class="grid grid-cols-3 font-bold text-gray-500"><span>Ticket</span><span class="text-right">Est.</span><span class="text-right">Logged</span></div>
                ${Object.entries(bugSummary).map(([bugTaskId, bug]) => {
                     const logged = totalScheduled[bugTaskId] || 0;
                     const logColor = logged > bug.totalHours ? 'text-red-600 font-bold' : 'text-gray-700';
                     return `
                    <div class="grid grid-cols-3">
                         <a href="https://oneline.atlassian.net/browse/${bug.ticketId}" target="_blank" class="hover:underline truncate">${bug.ticketId.replace(/^NCOP-/, '')}</a>
                         <span class="font-mono text-right">${bug.totalHours.toFixed(2)}h</span>
                         <span class="font-mono text-right ${logColor}">${logged.toFixed(2)}h</span>
                    </div>`
                }).join('')}
            </div>
        </div>`;
    }
    
    dashboard.innerHTML = `
    <details class="bg-white rounded-lg shadow p-4">
        <summary class="font-semibold cursor-pointer text-lg">Estimate Summary</summary>
        <div class="mt-4 border-t pt-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 max-h-64 overflow-y-auto pr-2">
                ${storyHtml || '<p class="text-sm text-gray-500">No stories found.</p>'}
                ${bugHtml || ''}
            </div>
        </div>
    </details>
    `;
}

function getTaskSummaries(sprint) {
    const storySummary = {}; // Key: ticketId
    const bugSummary = {}; // Key: taskId
    Object.entries(sprint.tasks).forEach(([taskId, task]) => {
        if (!task.ticketId || task.ticketId === 'N/A' || task.ticketId === 'DEMO_PREP') return;
        const isBug = task.type === 'verify' && task.name !== 'C/V Bugs';
        if (isBug) {
            bugSummary[taskId] = { ticketId: task.ticketId, totalHours: task.totalHours || 0, title: task.title, link: task.link };
        } else if (task.type === 'create' || task.type === 'execute' || task.name === 'C/V Bugs') {
             if (!storySummary[task.ticketId]) {
                storySummary[task.ticketId] = { title: task.title, link: task.link, subTasks: {} };
            }
            storySummary[task.ticketId].subTasks[taskId] = task.totalHours || 0;
        }
    });
    return { storySummary, bugSummary };
}

// --- EVENT HANDLING & ACTIONS ---
function addSprintContentEventListeners() {
    const container = document.getElementById('sprint-content');
    container.addEventListener('click', e => {
        const actionBtn = e.target.closest('[data-action]');
        if (actionBtn) {
            const { action, week, scheduledId, dayId } = actionBtn.dataset;
            switch(action) {
                case 'set-start-date': showCalendarModal("Set Sprint Start Date", (selectedDate) => {
                    appState.sprints[appState.activeSprintId].startDate = selectedDate;
                    renderApp();
                }); break;
                case 'show-exceeded': showExceededLogsModal(week); break;
                case 'dist-demo-prep': showDemoPrepModal(); break;
                case 'edit-single-task': showEditSingleTaskModal(scheduledId); break;
                case 'delete-single-task': handleDeleteSingleTask(scheduledId); break;
                case 'add-day-task': showAddTaskModal(dayId); break;
                case 'delete-day-tasks': handleDeleteAllTasks(dayId); break;
            }
        }
        
        const statusToggle = e.target.closest('.status-toggle');
        if(statusToggle) {
             const dayId = statusToggle.dataset.dayId;
             const state = statusToggle.dataset.state;
             const rect = statusToggle.getBoundingClientRect();
             const clickX = e.clientX - rect.left;
             let newState = state;
             if(clickX < rect.width / 3) newState = 'full';       // OFF
             else if (clickX > rect.width * 2 / 3) newState = 'half'; // HALF
             else newState = 'none';                              // ON
             
             if(newState !== state) {
                handleDayStatusChange(dayId, newState);
             }
        }
    });

    container.addEventListener('change', e => {
        const capacityInput = e.target.closest('.capacity-input');
        if (capacityInput) {
            handleCapacityChange(capacityInput.dataset.dayId, parseFloat(capacityInput.value));
            capacityInput.classList.add('changed');
            setTimeout(() => capacityInput.classList.remove('changed'), 1500);
        }
    });

    container.addEventListener('dragstart', handleDragStart);
    container.addEventListener('dragover', handleDragOver);
    container.addEventListener('dragleave', handleDragLeave);
    container.addEventListener('drop', handleDrop);
}

function handleCapacityChange(dayId, newCapacity) {
    if (isNaN(newCapacity) || newCapacity < 0) return;
    const sprint = appState.sprints[appState.activeSprintId];
    sprint.dailyLimits[dayId] = newCapacity;
    sprint.defaultDailyLimits[dayId] = newCapacity;
    renderApp();
}

function handleDayStatusChange(dayId, newStatus) {
    const sprint = appState.sprints[appState.activeSprintId];
    const oldStatus = sprint.daysOff[dayId];
    if (oldStatus === newStatus) return;

    sprint.daysOff[dayId] = newStatus;
    const defaultCapacity = sprint.defaultDailyLimits[dayId];

    if (newStatus === 'full') {
        sprint.dailyLimits[dayId] = 0;
        const tasksToMove = sprint.schedule[dayId] || [];
        if (tasksToMove.length > 0) {
            showMoveOrDeleteTasksModal(dayId, tasksToMove);
        } else {
            renderApp();
        }
    } else if (newStatus === 'half') {
        sprint.dailyLimits[dayId] = defaultCapacity / 2;
        const scheduledHours = (sprint.schedule[dayId] || []).reduce((s,t) => s + t.hours, 0);
        if (scheduledHours > sprint.dailyLimits[dayId]) {
            showHalfDayAdjustmentModal(dayId);
        } else {
            renderApp();
        }
    } else { // 'none'
        sprint.dailyLimits[dayId] = defaultCapacity;
        renderApp();
    }
}

function handleDeleteSingleTask(scheduledId) {
    const { dayId, scheduledTask } = findScheduledTaskById(scheduledId);
    if (!scheduledTask) return;
    
    const sprint = appState.sprints[appState.activeSprintId];
    const taskDef = sprint.tasks[scheduledTask.taskId];

    showConfirmationModal(`Are you sure you want to delete this task entry? <br>(${taskDef.ticketId.replace(/^NCOP-/, '')} - ${taskDef.name} - ${scheduledTask.hours}h)`, () => {
        sprint.schedule[dayId] = sprint.schedule[dayId].filter(t => t.id !== scheduledId);
        renderApp();
    });
}

function handleDeleteAllTasks(dayId) {
    const sprint = appState.sprints[appState.activeSprintId];
    if(!sprint.schedule[dayId] || sprint.schedule[dayId].length === 0) return;
    
    showConfirmationModal(`Are you sure you want to delete all tasks from ${dayMeta[dayId].name}?`, () => {
        delete sprint.schedule[dayId];
        renderApp();
    });
}

// --- DRAG & DROP LOGIC ---
function handleDragStart(e) {
    const card = e.target.closest('.task-card');
    if (card) {
        e.dataTransfer.setData('text/plain', card.dataset.scheduledId);
        e.dataTransfer.effectAllowed = 'move';
        setTimeout(() => card.classList.add('dragging'), 0);
    }
}
function handleDragOver(e) {
    e.preventDefault();
    const targetDayCol = e.target.closest('.day-column');
    if (targetDayCol) {
        const sprint = appState.sprints[appState.activeSprintId];
        if(sprint.daysOff[targetDayCol.dataset.dayId] !== 'full') {
             document.querySelectorAll('.day-column.drag-over').forEach(c => c.classList.remove('drag-over'));
            targetDayCol.classList.add('drag-over');
        }
    }
}
function handleDragLeave(e) {
    const dayColumn = e.target.closest('.day-column');
    if (dayColumn && !dayColumn.contains(e.relatedTarget)) {
       dayColumn.classList.remove('drag-over');
    }
}
function handleDrop(e) {
    e.preventDefault();
    document.querySelectorAll('.task-card.dragging').forEach(c => c.classList.remove('dragging'));
    document.querySelectorAll('.day-column.drag-over').forEach(c => c.classList.remove('drag-over'));
    const sourceScheduledId = e.dataTransfer.getData('text/plain');
    if (!sourceScheduledId) return;

    const targetDayCol = e.target.closest('.day-column');
    const targetDayId = targetDayCol?.dataset.dayId;
    
    const { dayId: sourceDayId, scheduledTask: sourceTask } = findScheduledTaskById(sourceScheduledId);

    if (targetDayId && sourceDayId && targetDayId !== sourceDayId && sourceTask) {
        const sprint = appState.sprints[appState.activeSprintId];
        const scheduledHoursOnTarget = (sprint.schedule[targetDayId] || []).reduce((sum, t) => sum + t.hours, 0);
        const capacityOnTarget = sprint.dailyLimits[targetDayId];

        const existingTaskOnTarget = sprint.schedule[targetDayId]?.find(t => t.taskId === sourceTask.taskId);
        
        if (scheduledHoursOnTarget + sourceTask.hours > capacityOnTarget && !existingTaskOnTarget) {
            showMessageModal("Cannot move task. Target day capacity would be exceeded.", "Move Failed");
            return;
        }

        const taskIndex = sprint.schedule[sourceDayId].findIndex(t => t.id === sourceScheduledId);
        const [taskToMove] = sprint.schedule[sourceDayId].splice(taskIndex, 1);
        if (!sprint.schedule[targetDayId]) sprint.schedule[targetDayId] = [];
        
        if (existingTaskOnTarget) {
            existingTaskOnTarget.hours += taskToMove.hours;
        } else {
            sprint.schedule[targetDayId].push(taskToMove);
        }
        renderApp();
    }
}

// --- TASK MODALS ---
function showAddTaskModal(dayId, previousData = {}) {
    const sprint = appState.sprints[appState.activeSprintId];
    const { availableTasks, dayScheduledHours } = getAvailableTasks(sprint, dayId);
    const dayCapacity = sprint.dailyLimits[dayId];
    const remainingCapacity = dayCapacity - dayScheduledHours;

    const taskGroups = {};
    const groupOrder = ['Create TCs', 'Execute TCs', 'Verify Bug'];
    
    availableTasks.forEach(task => {
        if(task.unplannedHours <= 0) return;
        const groupName = task.name === 'Verify Bug' ? 'Verify Bug' : 
                          task.name === 'Create TCs' ? 'Create TCs' : 
                          task.name === 'Execute TCs' ? 'Execute TCs' : 
                          'Other';
        if (!taskGroups[groupName]) taskGroups[groupName] = [];
        taskGroups[groupName].push(task);
    });

    const finalGroupOrder = groupOrder.concat(Object.keys(taskGroups).filter(k => !groupOrder.includes(k) && taskGroups[k].length > 0));
    
    const tabsHtml = finalGroupOrder.map(groupName => {
        if (!taskGroups[groupName]) return '';
        return `<button class="tab" data-group="${groupName}">${groupName}</button>`;
    }).join('');

    const renderTaskGroup = (groupName) => {
        const groupTasks = taskGroups[groupName] || [];
        groupTasks.sort((a, b) => (b.points || 0) - (a.points || 0));
        return groupTasks.map(task => {
            const fullText = `${task.ticketId} - ${task.name} - ${task.title}`;
            const shortText = `${task.ticketId.replace(/^NCOP-/, '')} - ${task.name}`;
            return `
            <div class="p-3 border rounded-md flex justify-between items-center bg-white" data-task-id="${task.id}">
                <div class="flex-grow pr-4 overflow-hidden">
                    <p class="font-medium truncate text-sm" title="${fullText}">${shortText}</p>
                    <p class="text-xs text-gray-500 truncate" title="${fullText}">${task.title}</p>
                </div>
                <div class="w-40 flex-shrink-0">
                    <input type="number" class="form-input add-task-hours-input text-right" placeholder="Rem: ${task.unplannedHours.toFixed(2)}h" min="0" step="0.25" value="${previousData[task.id] || ''}">
                </div>
            </div>
        `}).join('') || '<p class="text-center text-gray-500 p-4">No tasks available in this category.</p>';
    }
    
    const activeTab = appState.uiState.lastAddTaskTab && taskGroups[appState.uiState.lastAddTaskTab] ? appState.uiState.lastAddTaskTab : finalGroupOrder[0];

    const modalContent = showModal(`
        <div class="p-2 text-center rounded-md text-sm font-semibold ${remainingCapacity < 0 ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}">
            Day Capacity: ${remainingCapacity.toFixed(2)}h remaining
        </div>
        <div class="border-b border-gray-200 flex mt-4">${tabsHtml}</div>
        <div id="task-list-container" class="mt-4 space-y-2 max-h-60 overflow-y-auto pr-2">${renderTaskGroup(activeTab)}</div>
        <div class="flex justify-end mt-6">
            <button id="confirm-add-task-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md">Add Task(s)</button>
        </div>
    `, `Add Task to ${dayMeta[dayId].name}`);

    modalContent.querySelector('#task-list-container').querySelectorAll('.add-task-hours-input').forEach(input => {
        const taskId = input.closest('[data-task-id]').dataset.taskId;
        if(previousData[taskId]) input.value = previousData[taskId];
    });

    const tabs = modalContent.querySelectorAll('.tab');
    const taskListContainer = modalContent.querySelector('#task-list-container');
    modalContent.querySelector(`[data-group="${activeTab}"]`)?.classList.add('active');
    
    tabs.forEach(tab => {
        tab.onclick = () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            taskListContainer.innerHTML = renderTaskGroup(tab.dataset.group);
            appState.uiState.lastAddTaskTab = tab.dataset.group;
        }
    });

    modalContent.querySelector('#confirm-add-task-btn').onclick = () => {
        const inputs = modalContent.querySelectorAll('.add-task-hours-input');
        let totalHoursToAdd = 0;
        const tasksToAdd = [];
        const currentData = {};
        
        inputs.forEach(input => {
            const hours = parseFloat(input.value);
            const taskId = input.closest('[data-task-id]').dataset.taskId;
            currentData[taskId] = input.value;
            if(hours > 0) {
                tasksToAdd.push({ taskId, hours });
                totalHoursToAdd += hours;
            }
        });

        if (tasksToAdd.length === 0) return showMessageModal("No hours entered for any task.", "Input Required", () => showAddTaskModal(dayId, currentData), "Back");
        
        if (totalHoursToAdd > remainingCapacity + 0.01) {
            const autoAdjustHandler = () => {
                const adjustedTasks = tasksToAdd.map(t => ({...t}));
                let hoursToDistribute = remainingCapacity;
                
                adjustedTasks.forEach(task => {
                    const allocated = Math.min(task.hours, hoursToDistribute);
                    task.hours = allocated;
                    hoursToDistribute -= allocated;
                });
                
                addTasksToSchedule(sprint, dayId, adjustedTasks.filter(t => t.hours > 0));
            };
            showActionModal({
                title: "Capacity Exceeded",
                message: `Total hours to add (${totalHoursToAdd.toFixed(2)}h) exceed remaining capacity for this day (${remainingCapacity.toFixed(2)}h).`,
                buttons: [
                    { label: "Back", class: "bg-gray-200", handler: () => showAddTaskModal(dayId, currentData) },
                    { label: "Auto-Adjust to Capacity", class: "bg-blue-600 text-white", handler: autoAdjustHandler }
                ]
            });
            return;
        }
        
        addTasksToSchedule(sprint, dayId, tasksToAdd);
    };
}

function addTasksToSchedule(sprint, dayId, tasksToAdd) {
    const { availableTasks } = getAvailableTasks(sprint);
    tasksToAdd.forEach(taskData => {
        const taskInfo = availableTasks.find(t => t.id === taskData.taskId);
        let hoursToSchedule = taskData.hours;
        
        if (taskData.hours > taskInfo.unplannedHours + 0.01) {
            const exceededHours = taskData.hours - taskInfo.unplannedHours;
            hoursToSchedule = taskInfo.unplannedHours > 0 ? taskInfo.unplannedHours : 0;
            if (exceededHours > 0) {
                sprint.exceededLogs.push({ logId: `exlog-${Date.now()}`, fromTaskId: taskData.taskId, hours: exceededHours, dayLogged: dayId });
            }
        }
        if (!sprint.schedule[dayId]) sprint.schedule[dayId] = [];
        if (hoursToSchedule > 0) {
            const existingEntry = sprint.schedule[dayId].find(t => t.taskId === taskData.taskId);
            if (existingEntry) {
                existingEntry.hours += hoursToSchedule;
            } else {
                sprint.schedule[dayId].push({ id: `s_${dayId}_${taskData.taskId}_${Math.random()}`, taskId: taskData.taskId, hours: hoursToSchedule });
            }
        }
    });
    hideModal();
    renderApp();
}

function showEditSingleTaskModal(scheduledId) {
    const { dayId, scheduledTask } = findScheduledTaskById(scheduledId);
    if (!scheduledTask) return;
    const sprint = appState.sprints[appState.activeSprintId];
    const taskDef = sprint.tasks[scheduledTask.taskId];

    const modalContent = showModal(`
        <p class="text-sm text-gray-600 mb-4">Editing hours for <strong>${taskDef.ticketId.replace(/^NCOP-/, '')} - ${taskDef.name}</strong> on ${dayMeta[dayId].name}.</p>
        <div>
            <label for="edit-hours-input" class="block text-sm font-medium text-gray-700">Hours</label>
            <input id="edit-hours-input" type="number" class="form-input mt-1" value="${scheduledTask.hours.toFixed(2)}" step="0.25" min="0">
        </div>
        <div id="balance-notification" class="mt-4 p-2 text-center font-bold rounded-md"></div>
        <div class="flex justify-end mt-6">
            <button id="confirm-update-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md">Save Changes</button>
        </div>
    `, "Edit Task Hours");
    
    const input = modalContent.querySelector('#edit-hours-input');
    const notification = modalContent.querySelector('#balance-notification');
    const saveBtn = modalContent.querySelector('#confirm-update-btn');
    
    const checkBalance = () => {
        const newHours = parseFloat(input.value) || 0;
        const otherTasksHours = sprint.schedule[dayId]
            .filter(t => t.id !== scheduledId)
            .reduce((sum, t) => sum + t.hours, 0);
        const newTotal = otherTasksHours + newHours;
        const capacity = sprint.dailyLimits[dayId];
        const diff = newTotal - capacity;
        
        saveBtn.disabled = false;
        if (diff > 0.01) {
            notification.className = 'mt-4 p-2 text-center font-bold rounded-md bg-red-100 text-red-700';
            notification.textContent = `Over capacity by ${diff.toFixed(2)}h.`;
            saveBtn.disabled = true;
        } else {
            notification.className = 'mt-4 p-2 text-center font-bold rounded-md bg-green-100 text-green-700';
            notification.textContent = `Remaining capacity: ${(-diff).toFixed(2)}h.`;
        }
    };
    input.addEventListener('input', checkBalance);
    checkBalance();

    saveBtn.onclick = () => {
        scheduledTask.hours = parseFloat(input.value) || 0;
        if (scheduledTask.hours < 0.01) {
            sprint.schedule[dayId] = sprint.schedule[dayId].filter(t => t.id !== scheduledId);
        }
        hideModal();
        renderApp();
    };
}


function switchTab(sprintId) {
    appState.activeSprintId = sprintId;
    renderApp();
}
function updateSprintName(newName) {
    const sprint = appState.sprints[appState.activeSprintId];
    if (sprint) {
        sprint.sprintName = newName;
        renderTabs();
        saveState();
    }
}
function getDateForDayId(startDateStr, dayId) {
    if (!startDateStr) return null;
    const startDate = new Date(startDateStr + 'T00:00:00');
    const offset = dayOffsets[dayId];
    const targetDate = new Date(startDate);
    targetDate.setDate(startDate.getDate() + offset);
    return targetDate;
}
function getAvailableTasks(sprint, forDayId = null) {
    let dayScheduledHours = 0;
    if(forDayId && sprint.schedule[forDayId]) {
        dayScheduledHours = sprint.schedule[forDayId].reduce((sum, task) => sum + task.hours, 0);
    }
    const totalScheduled = Object.values(sprint.schedule).flat().reduce((acc, task) => {
        if (!acc[task.taskId]) acc[task.taskId] = 0;
        acc[task.taskId] += task.hours;
        return acc;
    }, {});
    const availableTasks = Object.entries(sprint.tasks)
        .map(([taskId, taskDef]) => {
            const scheduled = totalScheduled[taskId] || 0;
            const unplannedHours = (taskDef.totalHours || 0) - scheduled;
            return { id: taskId, ...taskDef, unplannedHours: unplannedHours > 0.01 ? unplannedHours : 0, scheduledHours: scheduled };
        });
    return { availableTasks, dayScheduledHours, totalScheduled };
}
function findScheduledTaskById(id) {
    const sprint = appState.sprints[appState.activeSprintId];
    if (!sprint) return {};
    for (const dayId in sprint.schedule) {
        const scheduledTask = sprint.schedule[dayId].find(t => t.id === id);
        if (scheduledTask) return { dayId, scheduledTask };
    }
    return {};
}

// --- SPRINT CREATION & DELETION ---
function showNewSprintDialog() {
    handlePasteAndCreateClick();
}

function handlePasteAndCreateClick() {
    const nextSprintNum = appState.uiState.lastSprintNumber + 1;
    const modalContent = showModal(`
        <div class="space-y-4">
            <div class="flex items-end gap-2">
                 <span class="text-lg font-medium text-gray-700 pt-1">Sprint</span>
                <input id="new-sprint-number" type="number" class="form-input" value="${nextSprintNum}">
            </div>
            <div>
                <label for="ticket-text-ai" class="block text-sm font-medium text-gray-700">Paste Ticket Data</label>
                <div class="relative mt-1">
                    <textarea id="ticket-text-ai" class="w-full h-48 p-2 border rounded-md font-mono text-xs" placeholder="Example:\nNCOP-9382\tBug - [UAT] Incorrect Logic\t5\tB\nNCOP-9879\tEnhance scalar function\t8\tS"></textarea>
                    <button id="paste-from-clipboard-btn" class="absolute top-2 right-2 px-3 py-1 text-xs bg-gray-200 rounded-md hover:bg-gray-300">Paste</button>
                </div>
            </div>
        </div>
        <div class="flex justify-end mt-6">
            <button id="confirm-create-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md">Create Sprint</button>
        </div>`, "âœ¨ Create New Sprint");
        
    const textArea = modalContent.querySelector('#ticket-text-ai');
    modalContent.querySelector('#paste-from-clipboard-btn').onclick = () => {
        navigator.clipboard.readText().then(text => { textArea.value = text; }).catch(err => {
            showMessageModal("Clipboard access was denied. Please paste manually.", "Clipboard Error");
        });
    };
    modalContent.querySelector('#confirm-create-btn').onclick = () => {
        const sprintNumber = modalContent.querySelector('#new-sprint-number').value.trim();
        if (!sprintNumber || isNaN(parseInt(sprintNumber))) return showMessageModal("Please enter a valid sprint number.", "Input Required", () => showNewSprintDialog(), "Back");
        const sprintName = `Sprint ${sprintNumber}`;

        const ticketText = textArea.value;
        if (!ticketText.trim()) return showMessageModal("Please paste some ticket information.", "Input Required", () => showNewSprintDialog(), "Back");
        
        try {
            const parsedTasks = parsePastedText(ticketText);
            if(parsedTasks.length === 0) throw new Error("Could not parse any valid tasks from the pasted text.");
            
            const newSprint = createSprintFromParsedTasks(parsedTasks, sprintName);
            const newSprintId = `sprint-${Date.now()}`;
            appState.sprints[newSprintId] = newSprint;
            appState.activeSprintId = newSprintId;
            appState.uiState.lastSprintNumber = parseInt(sprintNumber);
            hideModal();
            renderApp();
        } catch (e) {
            showMessageModal(`Failed to create board: ${e.message}`, "Parsing Error", () => showNewSprintDialog(), "Back");
        }
    };
}
function parsePastedText(text) {
    return text.split('\n').filter(line => line.trim() !== '').map(line => {
        const parts = line.split('\t').map(p => p.trim());
        if (parts.length < 4) return null;
        const [ticketId, title, pointsStr, type] = parts;
        const points = parseInt(pointsStr, 10);
        if (ticketId && title && !isNaN(points)) {
            return { ticketId, title, points, type: type.toUpperCase() };
        }
        return null;
    }).filter(Boolean);
}

function createSprintFromParsedTasks(parsedTasks, sprintName) {
    let newSprint = createNewSprintState(sprintName);
    const storySubTasks = [{ name: 'Create TCs', type: 'create', percentage: 50 }, { name: 'Execute TCs', type: 'execute', percentage: 40 }, { name: 'C/V Bugs', type: 'verify', percentage: 10 }];
    const hoursPerPoint = 4.5;
    let taskCounter = 1;
    (parsedTasks || []).forEach(pt => {
        const taskIdBase = `t${taskCounter++}`;
        const totalHours = pt.points * hoursPerPoint;
        if (pt.type === 'B') {
            newSprint.tasks[taskIdBase] = { name: 'Verify Bug', title: pt.title, ticketId: pt.ticketId, type: 'verify', totalHours, points: pt.points };
        } else {
            storySubTasks.forEach((subTask, i) => {
                const subTaskHours = totalHours * (subTask.percentage / 100);
                if (subTaskHours > 0.01) {
                     newSprint.tasks[`${taskIdBase}_${i}`] = { name: subTask.name, title: pt.title, ticketId: pt.ticketId, type: subTask.type, totalHours: subTaskHours, points: pt.points };
                }
            });
        }
    });
    newSprint.tasks['task_demo'] = { name: 'Demo Prep', ticketId: 'DEMO_PREP', type: 'demo', totalHours: 0 };
    return newSprint;
}
function createNewSprintState(name, startDate = null) {
    const defaultLimits = { w1d1: 4.0, w1d2: 6.75, w1d3: 5.75, w1d4: 2.75, w1d5: 6.75, w2d1: 6.75, w2d2: 6.75, w2d3: 6.75, w2d4: 4.75, w2d5: 3.5 };
    return { sprintName: name, startDate: startDate, dailyLimits: { ...defaultLimits }, defaultDailyLimits: { ...defaultLimits }, daysOff: Object.keys(dayMeta).reduce((acc, dayId) => ({...acc, [dayId]: 'none'}), {}), tasks: {}, schedule: {}, exceededLogs: [] };
}
function handleDeleteSprint() {
    if (Object.keys(appState.sprints).length <= 1) {
        return showMessageModal("Cannot delete the last sprint.", "Action not allowed");
    }
    const sprintsHtml = Object.entries(appState.sprints).map(([id, sprint]) => `
        <label class="flex items-center gap-3 p-2 border rounded-md hover:bg-gray-50">
            <input type="checkbox" class="h-4 w-4 rounded sprint-delete-checkbox" value="${id}">
            <span class="font-medium text-sm">${sprint.sprintName}</span>
        </label>
    `).join('');

    const modalContent = showModal(`
        <p class="text-sm text-gray-600 mb-4">Select the sprint(s) you want to permanently delete.</p>
        <div class="flex items-center gap-2 border-b pb-2 mb-2"><input type="checkbox" id="select-all-delete" class="h-4 w-4 rounded"><label for="select-all-delete" class="text-sm font-medium">Select All</label></div>
        <div class="space-y-2 max-h-60 overflow-y-auto">${sprintsHtml}</div>
        <div class="flex justify-end mt-6">
            <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-md">Delete Selected</button>
        </div>
    `, "Delete Sprints");
    const selectAll = modalContent.querySelector('#select-all-delete');
    const allCheckboxes = modalContent.querySelectorAll('.sprint-delete-checkbox');
    selectAll.addEventListener('change', () => {
        allCheckboxes.forEach(cb => cb.checked = selectAll.checked);
    });
    modalContent.querySelector('#confirm-delete-btn').onclick = () => {
        const checkedBoxes = modalContent.querySelectorAll('.sprint-delete-checkbox:checked');
        const idsToDelete = Array.from(checkedBoxes).map(cb => cb.value);
        if (idsToDelete.length === 0) return showMessageModal("No sprints selected.");
        if (Object.keys(appState.sprints).length - idsToDelete.length < 1) return showMessageModal("You cannot delete all sprints. At least one must remain.");
        showConfirmationModal(`Are you sure you want to delete ${idsToDelete.length} sprint(s)? This cannot be undone.`, () => {
            idsToDelete.forEach(id => delete appState.sprints[id]);
            if (idsToDelete.includes(appState.activeSprintId)) {
                appState.activeSprintId = Object.keys(appState.sprints)[0];
            }
            renderApp();
        });
    };
}

// --- DAY STATUS CHANGE MODALS ---
function showDemoPrepModal() {
    const sprint = appState.sprints[appState.activeSprintId];
    
    let demoTaskId = Object.keys(sprint.tasks).find(k => sprint.tasks[k].ticketId === 'DEMO_PREP');
    if (!demoTaskId) { 
        demoTaskId = `task_demo_${Date.now()}`;
        sprint.tasks[demoTaskId] = { name: 'Demo Prep', ticketId: 'DEMO_PREP', type: 'demo', totalHours: 0 };
    }
    const currentHours = sprint.tasks[demoTaskId].totalHours;
    
    const dayCheckboxHtml = (weekNum) => Object.keys(dayMeta).filter(d => dayMeta[d].week == weekNum).map(dayId => {
        const isChecked = (sprint.schedule[dayId] || []).some(t => t.taskId === demoTaskId);
        const isDisabled = (sprint.daysOff[dayId] === 'full');
        return `<label class="flex items-center space-x-2 p-1.5 border rounded-md ${isDisabled ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'hover:bg-gray-50 cursor-pointer'}">
            <input type="checkbox" value="${dayId}" class="demo-prep-day-cb h-4 w-4 rounded text-indigo-600" ${isChecked ? 'checked' : ''} ${isDisabled ? 'disabled' : ''}>
            <span class="text-xs font-medium">${dayMeta[dayId].name}</span>
        </label>`;
    }).join('');

    showModal(`
        <p class="text-sm text-gray-600 mb-4">Enter the total hours for demo prep and select the days to distribute it across.</p>
        <div>
            <label for="demo-hours" class="block text-sm font-medium text-gray-700">Total Demo Prep Hours</label>
            <input type="number" id="demo-hours" class="form-input mt-1" value="${currentHours || ''}" step="0.5" min="0">
        </div>
        <div class="mt-4">
            <div class="mb-2"><strong class="font-medium text-sm">Week 1</strong></div>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-2">${dayCheckboxHtml(1)}</div>
        </div>
        <div class="mt-4">
            <div class="mb-2"><strong class="font-medium text-sm">Week 2</strong></div>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-2">${dayCheckboxHtml(2)}</div>
        </div>
        <div class="flex justify-end mt-6">
            <button id="confirm-demo-prep" class="px-4 py-2 bg-purple-600 text-white rounded-md">Distribute Time</button>
        </div>
    `, "Distribute Demo Prep Time");

    document.getElementById('confirm-demo-prep').onclick = () => {
        const totalHours = parseFloat(document.getElementById('demo-hours').value);
        if (isNaN(totalHours) || totalHours <= 0) {
            return showMessageModal("Please enter a valid number of hours for demo prep.", "Input Required", null, "Back");
        }
        
        const selectedDays = Array.from(document.querySelectorAll('.demo-prep-day-cb:checked')).map(cb => cb.value);

        if (selectedDays.length === 0) {
            return showMessageModal("Please select at least one day to distribute hours.", "Input Required", null, "Back");
        }
        
        sprint.tasks[demoTaskId].totalHours = totalHours;
        
        Object.keys(sprint.schedule).forEach(dayId => {
            sprint.schedule[dayId] = sprint.schedule[dayId].filter(t => t.taskId !== demoTaskId);
        });
        
        const hoursPerDay = totalHours / selectedDays.length;
        let distributedTotal = 0;
        
        selectedDays.forEach((dayId, index) => {
            let hoursForThisDay = parseFloat(hoursPerDay.toFixed(2));
            if (index === selectedDays.length - 1) {
                hoursForThisDay = totalHours - distributedTotal;
            }

            if (!sprint.schedule[dayId]) sprint.schedule[dayId] = [];
            sprint.schedule[dayId].push({
                id: `s_${dayId}_${demoTaskId}_${Math.random()}`,
                taskId: demoTaskId,
                hours: hoursForThisDay
            });
            distributedTotal += hoursForThisDay;
        });

        hideModal();
        renderApp();
    };
}


function showMoveOrDeleteTasksModal(originalDayId, tasksToMove) {
    const sprint = appState.sprints[appState.activeSprintId];
    const taskListHtml = tasksToMove.map(task => {
        const taskDef = sprint.tasks[task.taskId];
        return `<li class="text-sm">${taskDef.ticketId} - ${taskDef.name} (${task.hours.toFixed(2)}h)</li>`;
    }).join('');

    showActionModal({
        title: 'Tasks on Day Off',
        message: `<strong>${dayMeta[originalDayId].name}</strong> was set to a full day off. What should happen to its scheduled tasks? <br><ul class="list-disc list-inside my-4 bg-gray-50 p-3 rounded-md">${taskListHtml}</ul>`,
        buttons: [
            { label: "Cancel", class: "bg-gray-200", handler: () => {
                sprint.daysOff[originalDayId] = 'none'; // Revert change
                hideModal();
                renderApp();
            }},
            { label: "Delete All", class: "bg-red-600 text-white", handler: () => {
                delete sprint.schedule[originalDayId];
                hideModal();
                renderApp();
            }},
            { label: "Move All", class: "bg-indigo-600 text-white", handler: () => showMoveTasksTargetModal(tasksToMove, originalDayId) }
        ]
    });
}

function showMoveTasksTargetModal(tasksToMove, originalDayId) {
    const sprint = appState.sprints[appState.activeSprintId];
    const dayOptions = Object.keys(dayMeta).filter(dayId => sprint.daysOff[dayId] !== 'full' && dayId !== originalDayId).map(dayId => {
        return `<option value="${dayId}">${dayMeta[dayId].name}</option>`;
    }).join('');

    const modalContent = showModal(`
        <p class="mb-4">Select a new day to move all tasks from <strong>${dayMeta[originalDayId].name}</strong>.</p>
        <select id="move-target-day" class="form-input">${dayOptions}</select>
        <div class="flex justify-end mt-6 gap-3">
            <button id="back-btn" class="px-4 py-2 bg-gray-200 rounded-md">Back</button>
            <button id="confirm-move-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md">Confirm Move</button>
        </div>
    `, 'Select Target Day');

    modalContent.querySelector('#back-btn').onclick = () => showMoveOrDeleteTasksModal(originalDayId, tasksToMove);

    modalContent.querySelector('#confirm-move-btn').onclick = () => {
        const targetDayId = modalContent.querySelector('#move-target-day').value;
        if (!targetDayId) return;

        if (!sprint.schedule[targetDayId]) sprint.schedule[targetDayId] = [];
        
        tasksToMove.forEach(task => {
            const existing = sprint.schedule[targetDayId].find(t => t.taskId === task.taskId);
            if(existing) {
                existing.hours += task.hours;
            } else {
                sprint.schedule[targetDayId].push(task);
            }
        });

        delete sprint.schedule[originalDayId];
        hideModal();
        renderApp();
    };
}

function showHalfDayAdjustmentModal(dayId) {
    const sprint = appState.sprints[appState.activeSprintId];
    const newCapacity = sprint.dailyLimits[dayId];
    const tasksOnDay = sprint.schedule[dayId] || [];
    const scheduledHours = tasksOnDay.reduce((s, t) => s + t.hours, 0);
    const overage = scheduledHours - newCapacity;

    const taskListHtml = tasksOnDay.map(task => {
        const taskDef = sprint.tasks[task.taskId];
        return `<li>${taskDef.name} (${taskDef.ticketId}): ${task.hours.toFixed(2)}h</li>`;
    }).join('');

    showActionModal({
        title: 'Adjust for Half Day',
        message: `<p class="mb-2"><strong>${dayMeta[dayId].name}</strong> is now a half day (${newCapacity.toFixed(2)}h). The currently scheduled ${scheduledHours.toFixed(2)}h exceeds this by <strong>${overage.toFixed(2)}h</strong>.</p>
                  <p class="mb-4">How do you want to adjust?</p>`,
        buttons: [
            { label: "Cancel", class: "bg-gray-200", handler: () => {
                sprint.daysOff[dayId] = 'none'; // Revert change
                hideModal();
                renderApp();
            }},
            { label: "Adjust Manually", class: "bg-green-600 text-white", handler: () => {
                hideModal();
                showUpdateDayModal(dayId);
            }},
            { label: "Auto-Reduce", class: "bg-blue-600 text-white", handler: () => {
                let reductionAmount = overage;
                tasksOnDay.sort((a,b) => b.hours - a.hours); // reduce from largest tasks first
                for(const task of tasksOnDay) {
                    if(reductionAmount <= 0) break;
                    const reduction = Math.min(task.hours, reductionAmount);
                    task.hours -= reduction;
                    reductionAmount -= reduction;
                }
                sprint.schedule[dayId] = tasksOnDay.filter(t => t.hours > 0.01);
                hideModal();
                renderApp();
            }}
        ]
    });
}


// --- GENERIC MODAL SYSTEM ---
function showModal(content, title = "") {
    const modal = document.getElementById('generic-modal');
    modal.innerHTML = `<div class="modal-content">
        <div class="flex justify-between items-start mb-4">
            <h2 class="text-lg font-semibold text-gray-800">${title}</h2>
            <button onclick="hideModal()" class="text-gray-400 hover:text-gray-600 z-10 p-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        <div>${content.replace(/<h3.*?>.*?<\/h3>/, '')}</div>
    </div>`;
    modal.classList.remove('hidden');
    setTimeout(() => modal.classList.remove('opacity-0'), 10);
    return modal.querySelector('.modal-content div:last-child');
}
function hideModal() {
    const modal = document.getElementById('generic-modal');
    modal.classList.add('opacity-0');
    setTimeout(() => { modal.classList.add('hidden'); modal.innerHTML = ''; }, 300);
}
function showMessageModal(message, title = "Alert", onOk = hideModal, okLabel = "OK") {
    const modalContent = showModal(`
        <p class="text-sm text-gray-600">${message}</p>
        <div class="flex justify-end mt-6">
            <button id="ok-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md">${okLabel}</button>
        </div>
    `, title);
    modalContent.querySelector('#ok-btn').onclick = onOk || hideModal;
}
function showConfirmationModal(message, onConfirm, title = "Confirmation") {
    showActionModal({
        title: title,
        message: message,
        buttons: [
            { label: "Cancel", class: "bg-gray-200", handler: hideModal },
            { label: "Confirm", class: "bg-red-600 text-white", handler: () => {
                if(onConfirm) onConfirm();
                hideModal();
            }}
        ]
    });
}

function showActionModal({ title, message, buttons = [] }) {
    const buttonsHtml = buttons.map((btn, index) => 
        `<button id="action-btn-${index}" class="px-4 py-2 rounded-md ${btn.class || 'bg-gray-200'}">${btn.label}</button>`
    ).join('');

    const modalContent = showModal(`
        <div class="text-sm text-gray-600">${message}</div>
        <div class="flex justify-end mt-6 gap-3">${buttonsHtml}</div>
    `, title);

    buttons.forEach((btn, index) => {
        modalContent.querySelector(`#action-btn-${index}`).onclick = () => {
            if (btn.handler) btn.handler();
        };
    });
}

function showCalendarModal(title, onConfirm, onCancel = hideModal) {
    const today = new Date();
    const modalContent = showModal(`
        <div id="calendar-container" class="max-w-xs mx-auto"></div>
        <div class="flex justify-end mt-4">
            <button id="calendar-cancel-btn" class="px-4 py-2 bg-gray-200 rounded-md">Cancel</button>
        </div>
    `, title);
    const calendarContainer = modalContent.querySelector('#calendar-container');
    const calendar = generateCalendar(today.getFullYear(), today.getMonth(), (selectedDate) => {
        hideModal();
        onConfirm(selectedDate);
    });
    calendarContainer.appendChild(calendar);
    modalContent.querySelector('#calendar-cancel-btn').onclick = onCancel;
}

function generateCalendar(year, month, onDateSelect) {
    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    const calendarEl = document.createElement('div');
    const firstDayOfMonth = new Date(year, month, 1);
    const firstDayIndex = (firstDayOfMonth.getDay() + 6) % 7; // Monday=0, Sunday=6
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    let html = `
        <div class="flex justify-between items-center mb-4">
            <button id="prev-month" class="p-2 rounded-full hover:bg-gray-200">&lt;</button>
            <span class="font-semibold text-lg">${monthNames[month]} ${year}</span>
            <button id="next-month" class="p-2 rounded-full hover:bg-gray-200">&gt;</button>
        </div>
        <div class="grid grid-cols-7 text-center text-xs text-gray-500 mb-2 font-medium">
            <div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div><div>Su</div>
        </div>
        <div class="grid grid-cols-7 gap-1">`;
    html += `<div></div>`.repeat(firstDayIndex);
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        html += `<div class="p-2 text-center rounded-full cursor-pointer hover:bg-indigo-100 transition-colors" data-date="${dateStr}">${day}</div>`;
    }
    html += `</div>`;
    calendarEl.innerHTML = html;

    calendarEl.querySelector('#prev-month').onclick = () => {
        calendarEl.replaceWith(generateCalendar(month === 0 ? year - 1 : year, month === 0 ? 11 : month - 1, onDateSelect));
    };
    calendarEl.querySelector('#next-month').onclick = () => {
        calendarEl.replaceWith(generateCalendar(month === 11 ? year + 1 : year, month === 11 ? 0 : month + 1, onDateSelect));
    };
    calendarEl.querySelectorAll('[data-date]').forEach(el => el.onclick = () => onDateSelect(el.dataset.date));
    return calendarEl;
}


// --- INITIALIZATION ---
window.onload = () => { loadState(); renderApp(); };
</script>
</body>
</html>
